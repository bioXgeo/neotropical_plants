---
title: "Tropical Andes plant occurrence data GBIF"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: "This script retrives plant occurrence data from GBIF using a subset of species with IUCN habitat designations ‘Forest-Subtropical/Tropical Moist Montane’ and/or ‘Forest-Subtropical/Tropical Moist Lowland’. Data is also retrived without the subset for species in the countries that make up the Tropical Andes to be spatially subset later, as not many plant species are assessed on the IUCN RedList. "
data input: "IUCN/Tropical Andes Plants - Search Results/habitats.csv"
data output: "TropAndes_GBIF_plant_occ.csv"
date: "2023-07-18"
output: html_document
---

# Set file paths
```{r}
data_path<-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
output_path<- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
```

# Load required packages
```{r}
library(dplyr)
library(rgbif) 
```

# Plant occurrences using IUCN habitat subset
## Read in IUCN data
Data was obtained from https://www.iucnredlist.org/search?permalink=9621ab77-2341-4bf8-9557-b7f19f7f2a35
```{r}
plants_habitats <- read.csv(file.path(data_path,"IUCN/Tropical Andes Plants - Search Results/habitats.csv"))
```

## Create species list from IUCN data
```{r}
plant_species <- unique(plants_habitats$scientificName)
print("The number of species on the IUCN is")
length(plant_species)
```

## Match species names to GBIF
```{r}
gbif_taxon_keys <- plant_species %>% 
name_backbone_checklist() %>% # match to backbone 
filter(!matchType == "NONE") %>% # get matched names
pull(usageKey) 
```

## Download data
```{r}
occ_download(
pred_in("taxonKey", gbif_taxon_keys),
pred("hasCoordinate", TRUE),
pred("hasGeospatialIssue", FALSE),
pred_in("country",c("EC","CO","VE", "PE", "BO")),
format = "SIMPLE_CSV"
)
```

## Retrive GBIF download, save file, and load into r
```{r}
d <- occ_download_get("0097296-230530130749713", path = output_path) %>%
  occ_download_import()
```

## Summary 
```{r}
glimpse(d)
```

```{r}
print("The number of occurrences is")
nrow(d)
print("The number of species is" )
length(unique(d$species))
print("The number of families is" )
length(unique(d$family))
```


# Plant occurrences without habitat subset

## Download data
```{r}
occ_download(
pred("hasCoordinate", TRUE),
pred("hasGeospatialIssue", FALSE),
pred_in("country",c("EC","CO","VE", "PE", "BO")),
format = "SIMPLE_CSV"
)
```

## Retrive GBIF download, save file, and load into r
```{r}
d2 <- occ_download_get("0097297-230530130749713", path = output_path, overwrite = TRUE) %>%
  occ_download_import()
```

## Summary 
```{r}
glimpse(d2)
```

```{r}
print("The number of occurrences is")
nrow(d2)
print("The number of species is" )
length(unique(d2$species))
print("The number of families is" )
length(unique(d2$family))
```

## Write data to csv
```{r}
TropicalAndes_GBIF_path <- file.path(output_path,"TropAndes_GBIF_plant_occ.csv") 
write.csv(d2, file = TropicalAndes_GBIF_path)
```