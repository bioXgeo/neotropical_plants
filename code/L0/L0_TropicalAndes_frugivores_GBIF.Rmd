---
title: "Tropical Andes montane and lowland forest bird and mammal species GBIF"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: "This script retrives plant occurrence data from GBIF using the species list from Frugivoria."
data input: "TropicalAndes_Frugivoria_frugivore_traits_species.csv"
data output: "TropicalAndes_GBIF_frugivore_occ.csv and TropicalAndes_GBIF_frugivore_occ_species.csv"
date: "2023-07-25"
output: html_document
---

# Set file paths
```{r}
data_path<-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
output_path<- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
```

# Load required packages
```{r}
library(dplyr)
library(rgbif) 
```

# Read in Frugivoria species list
```{r}
frugivore_species <- read.csv(file.path(data_path,"TropicalAndes_Frugivoria_frugivore_traits_species.csv"))
```

# Match species names to GBIF
```{r}
gbif_taxon_keys <- frugivore_species$x %>% 
name_backbone_checklist() %>% # match to backbone 
filter(!matchType == "NONE") %>% # get matched names
pull(usageKey) 
```

# Download data
```{r}
occ_download(
pred_in("taxonKey", gbif_taxon_keys),
pred("hasCoordinate", TRUE),
pred("hasGeospatialIssue", FALSE),
pred_in("country",c("EC","CO","VE", "PE", "BO")), 
format = "SIMPLE_CSV"
)
```

# Retrive GBIF download, save file, and load into r
```{r}
d <- occ_download_get("0129743-230530130749713", path = output_path, overwrite = TRUE) %>%
  occ_download_import()
```

# Summary 
```{r}
glimpse(d)
```

```{r}
print("The number of records is")
nrow(d)
print("The number of species is")
length(unique(d$species))
print("The number of families is")
length(unique(d$family))
```

# Extract species list
```{r}
GBIF_occ_SpeciesList <- unique(d$species)
```

# Write data to csv
```{r}
write.csv(d, file = file.path(output_path,"TropicalAndes_GBIF_frugivore_occ.csv"))

write.csv(GBIF_occ_SpeciesList, file = file.path(output_path,"TropicalAndes_GBIF_frugivore_occ_species.csv"))
```