---
title: "Tropical Andes Functional diversity for plants and Frugivores"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: "This script calculates functional diversity as functional dispersion for plants and frugivores."
date: "2023-08-03"
output: html_document
---

# Load required packages
```{r}
library(mFD)
library(sf)
library(dplyr)
library(ggplot2)
library(rnaturalearth)
library(ggspatial)
library(rlang)
library(doParallel)
library(foreach)
library(purrr)
library(ggpubr)
```

# Set file paths
```{r}
data_path_L1 <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
output_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L2')
figure_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/figures')
```

# Read in Data

```{r}
## projected sf objects
plants_sf_species <- readRDS(file = file.path(data_path_L1,"plants_sf_species.rds"))
frugivores_sf_species <- readRDS(file = file.path(data_path_L1,"frugivores_sf_species.rds"))
Americas <- readRDS(file = file.path(data_path_L1, "Americas.rds"))
TApoly <- readRDS(file = file.path(data_path_L1,"TApoly.rds"))
TropicalAndes_IUCNHabitat_Forest <- readRDS(file = file.path(data_path_L1,"TropicalAndes_IUCNHabitat_Forest.rds"))
```

```{r}
plant_traits_df_final <- readRDS(file = file.path(data_path_L1,"plant_traits_df_final.rds"))
frugivore_traits_df_final <- readRDS(file = file.path(data_path_L1,"frugivore_traits_df_final.rds"))
```

```{r}
site_loc_key_plant_100km <- readRDS(file = file.path(data_path_L1,"site_loc_key_plant_100km.rds"))
site_loc_key_frugivore_100km <- readRDS(file = file.path(data_path_L1,"site_loc_key_frugivore_100km.rds"))
PAM_plant_site_final_100km <- readRDS(file = file.path(data_path_L1,"PAM_plant_site_final_100km.rds"))
PAM_frugivore_site_final_100km <- readRDS(file = file.path(data_path_L1,"PAM_frugivore_site_final_100km.rds"))
```

```{r}
site_loc_key_plant_75km <- readRDS(file = file.path(data_path_L1,"site_loc_key_plant_75km.rds"))
site_loc_key_frugivore_75km <- readRDS(file = file.path(data_path_L1,"site_loc_key_frugivore_75km.rds"))
PAM_plant_site_final_75km <- readRDS(file = file.path(data_path_L1,"PAM_plant_site_final_75km.rds"))
PAM_frugivore_site_final_75km <- readRDS(file = file.path(data_path_L1,"PAM_frugivore_site_final_75km.rds"))
```

```{r}
site_loc_key_plant_50km <- readRDS(file = file.path(data_path_L1,"site_loc_key_plant_50km.rds"))
site_loc_key_frugivore_50km <- readRDS(file = file.path(data_path_L1,"site_loc_key_frugivore_50km.rds"))
PAM_plant_site_final_50km <- readRDS(file = file.path(data_path_L1,"PAM_plant_site_final_50km.rds"))
PAM_frugivore_site_final_50km <- readRDS(file = file.path(data_path_L1,"PAM_frugivore_site_final_50km.rds"))
```

```{r}
site_loc_key_plant_25km <- readRDS(file = file.path(data_path_L1,"site_loc_key_plant_25km.rds"))
site_loc_key_frugivore_25km <- readRDS(file = file.path(data_path_L1,"site_loc_key_frugivore_25km.rds"))
PAM_plant_site_final_25km <- readRDS(file = file.path(data_path_L1,"PAM_plant_site_final_25km.rds"))
PAM_frugivore_site_final_25km <- readRDS(file = file.path(data_path_L1,"PAM_frugivore_site_final_25km.rds"))
```

```{r}
site_loc_key_plant_10km <- readRDS(file = file.path(data_path_L1,"site_loc_key_plant_10km.rds"))
site_loc_key_frugivore_10km <- readRDS(file = file.path(data_path_L1,"site_loc_key_frugivore_10km.rds"))
PAM_plant_site_final_10km <- readRDS(file = file.path(data_path_L1,"PAM_plant_site_final_10km.rds"))
PAM_frugivore_site_final_10km <- readRDS(file = file.path(data_path_L1,"PAM_frugivore_site_final_10km.rds"))
```

```{r}
site_loc_key_plant_5km <- readRDS(file = file.path(data_path_L1,"site_loc_key_plant_5km.rds"))
site_loc_key_frugivore_5km <- readRDS(file = file.path(data_path_L1,"site_loc_key_frugivore_5km.rds"))
PAM_plant_site_final_5km <- readRDS(file = file.path(data_path_L1,"PAM_plant_site_final_5km.rds"))
PAM_frugivore_site_final_5km <- readRDS(file = file.path(data_path_L1,"PAM_frugivore_site_final_5km.rds"))
```

# Create trait type tables
```{r}
trait_name <- c("diet_cat", "body_mass_e", "body_size_mm", "generation_time")
trait_type <- c("N", "Q", "Q", "Q")
frug_trait_cat <- as.data.frame(cbind(trait_name, trait_type))
```

```{r}
trait_name <- c("PlantLifespan_years","GrowthForm", "SeedMass_g", "PlantHeight_m", "FruitType", "FruitLength_mm",
                "SeedWidth_mm", "FruitMass_mg", "SeedLength_mm", "DispersalSyndrome")
trait_type <- c("Q", "N", "Q", "Q", "N", "Q", "Q", "Q", "Q", "N") 
plant_trait_cat <- as.data.frame(cbind(trait_name, trait_type))
```

```{r}
# fix Nominal traits as factor
frugivore_traits_df_final$diet_cat <- as.factor(frugivore_traits_df_final$diet_cat)

plant_traits_df_final$GrowthForm <- as.factor(plant_traits_df_final$GrowthForm)
plant_traits_df_final$FruitType <- as.factor(plant_traits_df_final$FruitType)
plant_traits_df_final$DispersalSyndrome <- as.factor(plant_traits_df_final$DispersalSyndrome)
```

# Frugivores
## 100 km
```{r}
# Summary of the assemblages * species dataframe
asb_sp_frugivore_summ <- mFD::asb.sp.summary(asb_sp_w = PAM_frugivore_site_final_100km)
```

```{r}
# Species traits summary
frugivore_traits_summ <- mFD::sp.tr.summary(tr_cat = frug_trait_cat, sp_tr = frugivore_traits_df_final)
```

```{r}
# Estimate functional trait-based distances between species
sp_dist_frugivore <- mFD::funct.dist( sp_tr = frugivore_traits_df_final, tr_cat = frug_trait_cat, metric = "gower",
  scale_euclid = "scale_center", ordinal_var = "classic", weight_type = "equal", stop_if_NA = TRUE)
```

```{r}
# Generate a multidimensional space
fspaces_quality_frugivore <- mFD::quality.fspaces(sp_dist = sp_dist_frugivore, maxdim_pcoa = 10, deviation_weighting = "absolute",
                                                  fdist_scaling = FALSE, fdendro = "average")
```

```{r}
# Look at the quality spaces only (MAD index looks at the mean absolute deviation from the dissimilarity matrix; want the deviation to be low meaning that the true distances have been retained in the PCA)
round(fspaces_quality_frugivore$"quality_fspaces", 3)
```

```{r}
# Plot the quality spaces (chose to look at 3D, 4D, and 5D since they had the lowest MAD). Will go with 3 dimensions
mFD::quality.fspaces.plot(fspaces_quality = fspaces_quality_frugivore, quality_metric = "mad",
                          fspaces_plot = c("pcoa_3d", "pcoa_4d", "pcoa_5d"))
```

```{r}
#testing correlation between functional axes and traits
sp_faxes_coord_frugivore <- fspaces_quality_frugivore$"details_fspaces"$"sp_pc_coord"
```

```{r}
# Computes linear model for continuous traits and Kruskall-Wallis tests for other types. 
frugivore_tr_faxes <- mFD::traits.faxes.cor(sp_tr = frugivore_traits_df_final, 
                                            sp_faxes_coord = sp_faxes_coord_frugivore[ , c("PC1", "PC2", "PC3", "PC4")],
                                            plot = TRUE)

# Print traits with significant effect:
frugivore_tr_faxes$"tr_faxes_stat"[which(frugivore_tr_faxes$"tr_faxes_stat"$"p.value" < 0.05), ]
# Return plots:
frugivore_tr_faxes$"tr_faxes_plot"
```

```{r}
#plotting functional space
sp_faxes_coord_frugivore <- fspaces_quality_frugivore$"details_fspaces"$"sp_pc_coord"

big_plot_frugivore <- mFD::funct.space.plot(sp_faxes_coord = sp_faxes_coord_frugivore[ , c("PC1", "PC2", "PC3", "PC4")],
                                            faxes = c("PC1", "PC2", "PC3", "PC4"), alpha_ch = 0.5, shape_vert = 6)
big_plot_frugivore
```

```{r}
#Need to remove parts of the PAM that have values less than or equal to the number of dimensions (3)
# Calculate row sums
row_sums_frugivore <- rowSums(PAM_frugivore_site_final_100km)
subset_matrix_frugivore <- PAM_frugivore_site_final_100km[row_sums_frugivore >= 3, ]
```

```{r}
# match frugivore names
sp_faxes_coord_frugivore_sub <- sp_faxes_coord_frugivore[ , c("PC1", "PC2", "PC3", "PC4")]
summary(sp_faxes_coord_frugivore_sub)
```


```{r}
## check number of species names
nrow(sp_faxes_coord_frugivore_sub)
ncol(subset_matrix_frugivore) 
```

```{r}
sp_faxes_coord_frugivore_sub_names <- row.names(sp_faxes_coord_frugivore_sub)
subset_matrix_frugivore_names <- colnames(subset_matrix_frugivore)
```

```{r}
sp_faxes_coord_frugivore_sub <- as.data.frame(sp_faxes_coord_frugivore_sub)
row.names(sp_faxes_coord_frugivore_sub) <- sp_faxes_coord_frugivore_sub_names

sp_faxes_coord_frugivore_sub_names <- row.names(sp_faxes_coord_frugivore_sub)
subset_matrix_frugivore_names <- colnames(subset_matrix_frugivore)

frugivore_names <- intersect(sp_faxes_coord_frugivore_sub_names, subset_matrix_frugivore_names)
frugivore_names <- na.omit(frugivore_names)

sp_faxes_coord_frugivore_sub <- sp_faxes_coord_frugivore_sub[ which((row.names(sp_faxes_coord_frugivore_sub) %in% frugivore_names)==TRUE), ]

subset_matrix_frugivore  <- as.data.frame(subset_matrix_frugivore)
subset_matrix_frugivore <- subset_matrix_frugivore[ ,which((colnames(subset_matrix_frugivore) %in% frugivore_names)==TRUE)]

#remove NAs
sp_faxes_coord_frugivore_sub <- na.omit(sp_faxes_coord_frugivore_sub)
subset_matrix_frugivore <- na.omit(subset_matrix_frugivore)
```

```{r}
nrow(sp_faxes_coord_frugivore_sub)
ncol(subset_matrix_frugivore)
```

```{r}
sp_faxes_coord_frugivore_sub <- as.matrix(sp_faxes_coord_frugivore_sub)
subset_matrix_frugivore <- as.matrix(subset_matrix_frugivore)
```

```{r}
# Computing FD
# The number of species per assemblage has to be higher or equal to the number of traits

alpha_fd_indices_frugivore <- mFD::alpha.fd.multidim(sp_faxes_coord = sp_faxes_coord_frugivore_sub, asb_sp_w = subset_matrix_frugivore,
                                                     ind_vect = "fdis", details_returned = TRUE)

details_list_frugivore <- alpha_fd_indices_frugivore$"details"
```

```{r}
# Get functional dispersion
fdis_frugivore <- alpha_fd_indices_frugivore$functional_diversity_indices$fdis
```


### Mapping FD

```{r}
# Generate coordinates
subset_coords_frugivore <-site_loc_key_frugivore_100km[rowSums(PAM_frugivore_site_final_100km) >= 3, ]
subset_coords_frugivore_sp <-subset_coords_frugivore[,1:2 ]

frugivore_fd_sp <- data.frame(subset_coords_frugivore_sp, fdis_frugivore)
```

```{r}
# Convert the dataframe to sf format
spatial_fdis_frugivore <- st_as_sf(frugivore_fd_sp, coords = c("Longitude", "Latitude"))
```

```{r}
# set crs of sf objects
spatial_fdis_frugivore <- spatial_fdis_frugivore %>% st_set_crs(5389)
```

```{r}
# Extract coordinates 
spatial_fdis_frugivore_coords <- st_coordinates(spatial_fdis_frugivore)

# Add coordinates as separate columns
spatial_fdis_frugivore <- spatial_fdis_frugivore %>%
  mutate(x = spatial_fdis_frugivore_coords[, 1], y = spatial_fdis_frugivore_coords[, 2])
```

```{r}
summary(spatial_fdis_frugivore)
```

```{r}
TAGrid_100km <- TApoly %>%
  st_make_grid(cellsize = c(100000)) %>%
  st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
  st_cast("MULTIPOLYGON") %>%
  st_sf() %>%
  mutate(cellid = row_number())

spatial_fdis_frugivore$cellid <- st_intersects(spatial_fdis_frugivore, TAGrid_100km)$nn

spatial_fdis_frugivore_grid <- TAGrid_100km %>%
   st_join(spatial_fdis_frugivore) %>%
   group_by(cellid) %>%
   summarize(fdis_value = sum(fdis_frugivore, na.rm = TRUE)) %>%
   ungroup()
```


```{r}
summary(spatial_fdis_frugivore_grid)
```

```{r}
frugivoregridFDisTA_100km <-
    ggplot() +
    geom_sf(data = Americas, fill = "white")+
    geom_sf(data = TApoly, fill = "lightgrey", size = 0.1) +
    geom_sf(data = spatial_fdis_frugivore_grid, aes(fill = fdis_value), color = NA) +
    labs(fill = "FDis") +
    ggtitle("100 km") +
    scale_fill_distiller(palette = "YlOrBr", direction = 1) +
    coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
    theme(panel.background = element_rect(fill = "lightblue"),
        text = element_text(size = 12), plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
frugivoregridFDisTA_100km
```

```{r}
ggsave("frugivoregridFDisTA_100km.png", frugivoregridFDisTA_100km, path = figure_path)
# Extract cell values
frugivore_cellFDis_100km <- spatial_fdis_frugivore_grid
hist(frugivore_cellFDis_100km$fdis_value)
```

## Create function to calculate FD as fdis for frugivores for other spatial grains
Uses inputs from trait objects created above to avoid redundancies 
```{r}
calculate_fd_as_fdis_frugivores <- function(PAM_site_final) {
  # Calculate row sums and subset matrix early to avoid unnecessary calculations
  row_sums_frugivore <- rowSums(PAM_site_final)
  subset_matrix_frugivore <- PAM_site_final[row_sums_frugivore >= 4, ]
  
  # Select the necessary columns from sp_faxes_coord_frugivore
  sp_faxes_coord_frugivore_sub <- sp_faxes_coord_frugivore[, c("PC1", "PC2", "PC3", "PC4")]
  
  ## check number of species names
  print(nrow(sp_faxes_coord_frugivore_sub))
  print(ncol(subset_matrix_frugivore)) 
  

  sp_faxes_coord_frugivore_sub_names <- row.names(sp_faxes_coord_frugivore_sub)
  subset_matrix_frugivore_names <- colnames(subset_matrix_frugivore)
  
  sp_faxes_coord_frugivore_sub <- as.data.frame(sp_faxes_coord_frugivore_sub)
  row.names(sp_faxes_coord_frugivore_sub) <- sp_faxes_coord_frugivore_sub_names
  
  sp_faxes_coord_frugivore_sub_names <- row.names(sp_faxes_coord_frugivore_sub)
  subset_matrix_frugivore_names <- colnames(subset_matrix_frugivore)
  
  frugivore_names <- intersect(sp_faxes_coord_frugivore_sub_names, subset_matrix_frugivore_names)
  frugivore_names <- na.omit(frugivore_names)
  
  sp_faxes_coord_frugivore_sub <- sp_faxes_coord_frugivore_sub[ which((row.names(sp_faxes_coord_frugivore_sub) %in%
                                                                         frugivore_names)==TRUE), ]
  
  subset_matrix_frugivore  <- as.data.frame(subset_matrix_frugivore)
  subset_matrix_frugivore <- subset_matrix_frugivore[ ,which((colnames(subset_matrix_frugivore) %in% frugivore_names)==TRUE)]
  
  #remove NAs
  sp_faxes_coord_frugivore_sub <- na.omit(sp_faxes_coord_frugivore_sub)
  subset_matrix_frugivore <- na.omit(subset_matrix_frugivore)
  
  print(nrow(sp_faxes_coord_frugivore_sub))
  print(ncol(subset_matrix_frugivore)) 

  
  if (nrow(sp_faxes_coord_frugivore_sub) != ncol(subset_matrix_frugivore)) {
    stop("Number of rows in sp_faxes_coord_frugivore_sub does not match number of columns in subset_matrix_frugivore")
  }
  
  sp_faxes_coord_frugivore_sub <- as.matrix(sp_faxes_coord_frugivore_sub)
  subset_matrix_frugivore <- as.matrix(subset_matrix_frugivore)
  
  # Use three fewer cores than available
  num_cores <- parallel::detectCores() - 3
  
  # Set up parallel backend
  cl <- makeCluster(num_cores)
  registerDoParallel(cl)
  
  tryCatch({
    # Define chunk size
    chunk_size <- ceiling(nrow(subset_matrix_frugivore) / num_cores)
    
    # Split data into chunks for parallel processing
    chunks <- split(seq_len(nrow(subset_matrix_frugivore)), ceiling(seq_len(nrow(subset_matrix_frugivore)) / chunk_size))
    
    # Process chunks in parallel
    results_list <- foreach(chunk_indices = chunks, .combine = rbind, .packages = "mFD") %dopar% {
      subset_matrix_frugivore_chunk <- subset_matrix_frugivore[chunk_indices, , drop = FALSE]
      
      alpha_fd_indices_frugivore <- mFD::alpha.fd.multidim(
        sp_faxes_coord = sp_faxes_coord_frugivore_sub, 
        asb_sp_w = subset_matrix_frugivore_chunk, 
        ind_vect = "fdis", 
        details_returned = TRUE
      )
     # Extract fdis values and match with corresponding cell numbers
      fdis_values <- alpha_fd_indices_frugivore$functional_diversity_indices$fdis
      cell_numbers <- rownames(subset_matrix_frugivore)[chunk_indices]
      
      # Create a data frame for this chunk
      chunk_results <- data.frame(Cell_Number = cell_numbers, fdis = fdis_values)
      chunk_results
    }
    
    # Combine all chunk results into a single data frame
    all_results <- do.call(rbind, results_list)
    
    # Stop the parallel backend
    stopCluster(cl)
    
    return(results_list)
  }, error = function(e) {
    stop("Error in parallel processing: ", conditionMessage(e))
  })
}
  
```

```{r}
fdis_frugivore_75km <- calculate_fd_as_fdis_frugivores(PAM_frugivore_site_final_75km)
```

```{r}
fdis_frugivore_50km <- calculate_fd_as_fdis_frugivores(PAM_frugivore_site_final_50km)
```

```{r}
fdis_frugivore_25km <- calculate_fd_as_fdis_frugivores(PAM_frugivore_site_final_25km)
```

```{r}
fdis_frugivore_10km <- calculate_fd_as_fdis_frugivores(PAM_frugivore_site_final_10km)
```

```{r}
fdis_frugivore_5km <- calculate_fd_as_fdis_frugivores(PAM_frugivore_site_final_5km)
```

## Map FD for spatial grains other than 100 km
```{r}
mapping_fd_as_fdis_frugivores <- function(PAM_frugivore_site, site_loc_key_frugivore, fdis_frugivore, resolution_meters) {
  # Generate coordinates
  subset_coords_frugivore <- site_loc_key_frugivore[rowSums(PAM_frugivore_site) >= 4, ]
  subset_coords_frugivore_sp <-subset_coords_frugivore[,1:2 ]

  frugivore_fd_sp <- data.frame(subset_coords_frugivore_sp, fdis_frugivore)
  
  # Convert the dataframe to sf format
  spatial_fdis_frugivore <- st_as_sf(frugivore_fd_sp, coords = c("Longitude", "Latitude"))
  
  # set crs of sf objects
  spatial_fdis_frugivore <- spatial_fdis_frugivore %>% st_set_crs(5389)
  
  # Extract coordinates 
  spatial_fdis_frugivore_coords <- st_coordinates(spatial_fdis_frugivore)

  # Add coordinates as separate columns
  spatial_fdis_frugivore <- spatial_fdis_frugivore %>%
    mutate(x = spatial_fdis_frugivore_coords[, 1], y = spatial_fdis_frugivore_coords[, 2])
  
  TAGrid <- TApoly %>%
    st_make_grid(cellsize = c(resolution_meters)) %>%
    st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
    st_cast("MULTIPOLYGON") %>%
    st_sf() %>%
    mutate(cellid = row_number())

  spatial_fdis_frugivore$cellid <- st_intersects(spatial_fdis_frugivore, TAGrid)$nn

  spatial_fdis_frugivore_grid <- TAGrid %>%
   st_join(spatial_fdis_frugivore) %>%
   group_by(cellid) %>%
   summarize(fdis_value = sum(fdis_frugivore, na.rm = TRUE)) %>%
   ungroup()
  
  frugivoregridFDisTA <-
    ggplot() +
    geom_sf(data = Americas, fill = "white")+
    geom_sf(data = TApoly, fill = "lightgrey", size = 0.1) +
    geom_sf(data = spatial_fdis_frugivore_grid, aes(fill = fdis_value), color = NA) +
    labs(fill = "FDis") +
    scale_fill_distiller(palette = "YlOrBr", direction = 1) +
    coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
    theme(panel.background = element_rect(fill = "lightblue"),
        text = element_text(size = 12), plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
  frugivoregridFDisTA
  
  list(frugivoregridFDisTA = frugivoregridFDisTA,
         spatial_fdis_frugivore_grid = spatial_fdis_frugivore_grid)
}
```

```{r}
mapping_75km <- mapping_fd_as_fdis_frugivores(PAM_frugivore_site_final_75km, site_loc_key_frugivore_75km, fdis_frugivore_75km$fdis, 75000)
frugivoregridFDisTA_75km <- mapping_75km$frugivoregridFDisTA
frugivore_cellFDis_75km <- mapping_75km$spatial_fdis_frugivore_grid
```

```{r}
# add title to maps
(frugivoregridFDisTA_75km <- frugivoregridFDisTA_75km +
    ggtitle("75 km")
)
ggsave("frugivoregridFDisTA_75km.png", frugivoregridFDisTA_75km, path = figure_path)
```

```{r}
mapping_50km <- mapping_fd_as_fdis_frugivores(PAM_frugivore_site_final_50km, site_loc_key_frugivore_50km, fdis_frugivore_50km$fdis, 50000)
frugivoregridFDisTA_50km <- mapping_50km$frugivoregridFDisTA
frugivore_cellFDis_50km <- mapping_50km$spatial_fdis_frugivore_grid
```

```{r}
# add title to maps
(frugivoregridFDisTA_50km <- frugivoregridFDisTA_50km +
    ggtitle("50 km")
)
ggsave("frugivoregridFDisTA_50km.png", frugivoregridFDisTA_50km, path = figure_path)
```

```{r}
mapping_25km <- mapping_fd_as_fdis_frugivores(PAM_frugivore_site_final_25km, site_loc_key_frugivore_25km, fdis_frugivore_25km$fdis, 25000)
frugivoregridFDisTA_25km <- mapping_25km$frugivoregridFDisTA
frugivore_cellFDis_25km <- mapping_25km$spatial_fdis_frugivore_grid
```

```{r}
# add title to maps
(frugivoregridFDisTA_25km <- frugivoregridFDisTA_25km +
    ggtitle("25 km")
)
ggsave("frugivoregridFDisTA_25km.png", frugivoregridFDisTA_25km, path = figure_path)
```

```{r}
mapping_10km <- mapping_fd_as_fdis_frugivores(PAM_frugivore_site_final_10km, site_loc_key_frugivore_10km, fdis_frugivore_10km$fdis, 10000)
frugivoregridFDisTA_10km <- mapping_10km$frugivoregridFDisTA
frugivore_cellFDis_10km <- mapping_10km$spatial_fdis_frugivore_grid
```

```{r}
# add title to maps
(frugivoregridFDisTA_10km <- frugivoregridFDisTA_10km +
    ggtitle("10 km")
)
ggsave("frugivoregridFDisTA_10km.png", frugivoregridFDisTA_10km, path = figure_path)
```

```{r}
# Generate coordinates
subset_coords_frugivore_5km <-site_loc_key_frugivore_5km[rowSums(PAM_frugivore_site_final_5km) >= 4, ]
subset_coords_frugivore_sp_5km <-subset_coords_frugivore_5km[,1:2 ]

frugivore_fd_sp_5km <- data.frame(subset_coords_frugivore_sp_5km, fdis_frugivore_5km)
```

```{r}
# Convert the dataframe to sf format
spatial_fdis_frugivore_5km <- st_as_sf(frugivore_fd_sp_5km, coords = c("Longitude", "Latitude"))
```

```{r}
# set crs of sf objects
spatial_fdis_frugivore_5km <- spatial_fdis_frugivore_5km %>% st_set_crs(5389)
```

```{r}
# Extract coordinates 
spatial_fdis_frugivore_coords_5km <- st_coordinates(spatial_fdis_frugivore_5km)

# Add coordinates as separate columns
spatial_fdis_frugivore_5km <- spatial_fdis_frugivore_5km %>%
  mutate(x = spatial_fdis_frugivore_coords_5km[, 1], y = spatial_fdis_frugivore_coords_5km[, 2])
```


```{r}
TAGrid_5km <- TApoly %>%
  st_make_grid(cellsize = c(5000)) %>%
  st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
  st_cast("MULTIPOLYGON") %>%
  st_sf() %>%
  mutate(cellid = row_number())

spatial_fdis_frugivore_5km$cellid <- st_intersects(spatial_fdis_frugivore_5km, TAGrid_5km)$nn

```

```{r}
# Determine number of cores to use
num_cores <- detectCores() - 2

# Register parallel backend
cl <- makeCluster(num_cores)
registerDoParallel(cl)

# Ensure the cluster stops when done
on.exit(stopCluster(cl))

# Split TAGrid_5km indices into chunks for parallel processing
chunk_indices <- split(seq_len(nrow(TAGrid_5km)), rep(1:num_cores, each = ceiling(nrow(TAGrid_5km) / num_cores), length.out = nrow(TAGrid_5km)))

# Perform spatial join and aggregation in parallel
results_list <- foreach(indices = chunk_indices, .combine = 'c', .packages = c("sf", "dplyr")) %dopar% {
  grid_chunk <- TAGrid_5km[indices, ]
  
  # Perform spatial join
  joined <- st_join(grid_chunk, spatial_fdis_frugivore_5km)
  
  # Group by cellid and summarize fdis values
  summarized <- joined %>%
    group_by(cellid) %>%
    summarize(fdis_value = sum(fdis, na.rm = TRUE)) %>%
    ungroup()
  
  # Ensure that summarized is a data frame and add debugging information
  summarized_df <- as.data.frame(summarized)
  
  # Debugging: Check the structure of the summarized data frame
  message("Processed chunk: ", indices[1], " to ", indices[length(indices)])
  str(summarized_df)
  
  list(summarized_df)  # Return as list to avoid unintended simplification
}

# Flatten the results_list and ensure each element is a data frame
flattened_results <- map_dfr(results_list, ~ as.data.frame(.x))

# Check the structure of the combined result
str(flattened_results)

# Convert to sf object if applicable
if ("geometry" %in% colnames(flattened_results)) {
  spatial_fdis_frugivore_grid <- st_as_sf(flattened_results)
} else {
  spatial_fdis_frugivore_grid <- flattened_results
}

# Check the structure of the final output
str(spatial_fdis_frugivore_grid)

```

```{r}
frugivoregridFDisTA_5km <-
    ggplot() +
    geom_sf(data = Americas, fill = "white")+
    geom_sf(data = TApoly, fill = "lightgrey", size = 0.1) +
    geom_sf(data = spatial_fdis_frugivore_grid, aes(fill = fdis_value), color = NA) +
    labs(fill = "FDis") +
    scale_fill_distiller(palette = "YlOrBr", direction = 1) +
    coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
    theme(panel.background = element_rect(fill = "lightblue"),
        text = element_text(size = 12), plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
  frugivoregridFDisTA_5km
frugivore_cellFDis_5km <- spatial_fdis_frugivore_grid
```

```{r}
# add title to maps
(frugivoregridFDisTA_5km <- frugivoregridFDisTA_5km +
    ggtitle("5 km")
)
ggsave("frugivoregridFDisTA_5km.png", frugivoregridFDisTA_5km, path = figure_path)
```

# Plants

## 100 km
```{r}
# Summary of the assemblages * species dataframe
asb_sp_plant_summ <- mFD::asb.sp.summary(asb_sp_w = PAM_plant_site_final_100km)
```

```{r}
# Species traits summary
plant_traits_summ <- mFD::sp.tr.summary(tr_cat = plant_trait_cat, sp_tr = plant_traits_df_final)
```

```{r}
# Estimate functional trait-based distances between species
sp_dist_plant <- mFD::funct.dist( sp_tr = plant_traits_df_final, tr_cat = plant_trait_cat, metric = "gower",
  scale_euclid = "scale_center", ordinal_var = "classic", weight_type = "equal", stop_if_NA = TRUE)
```

```{r}
# Generate a multidimensional space
fspaces_quality_plant <- mFD::quality.fspaces(sp_dist = sp_dist_plant, maxdim_pcoa = 10, deviation_weighting = "absolute",
                                                  fdist_scaling = FALSE, fdendro = "average")
```

```{r}
# Look at the quality spaces only (MAD index looks at the mean absolute deviation from the dissimilarity matrix; want the deviation to be low meaning that the true distances have been retained in the PCA)
round(fspaces_quality_plant$"quality_fspaces", 3)
```

```{r}
# Plot the quality spaces (chose to look at )
mFD::quality.fspaces.plot(fspaces_quality = fspaces_quality_plant, quality_metric = "mad",
                          fspaces_plot = c("pcoa_6d", "pcoa_7d", "pcoa_8d"))
```

```{r}
#testing correlation between functional axes and traits
sp_faxes_coord_plant <- fspaces_quality_plant$"details_fspaces"$"sp_pc_coord"
```

```{r}
# Computes linear model for continuous traits and Kruskall-Wallis tests for other types. 
plant_tr_faxes <- mFD::traits.faxes.cor(sp_tr = plant_traits_df_final, 
                                            sp_faxes_coord = sp_faxes_coord_plant[ , c("PC1", "PC2", "PC3", "PC4")],
                                            plot = TRUE)

# Print traits with significant effect:
plant_tr_faxes$"tr_faxes_stat"[which(plant_tr_faxes$"tr_faxes_stat"$"p.value" < 0.05), ]
# Return plots:
plant_tr_faxes$"tr_faxes_plot"
```

```{r}
#plotting functional space
sp_faxes_coord_plant <- fspaces_quality_plant$"details_fspaces"$"sp_pc_coord"

big_plot_plant <- mFD::funct.space.plot(sp_faxes_coord = sp_faxes_coord_plant[ , c("PC1", "PC2", "PC3", "PC4")],
                                            faxes = c("PC1", "PC2", "PC3", "PC4"), alpha_ch = 0.5, shape_vert = 6)
big_plot_plant
```

```{r}
#Need to remove parts of the PAM that have values less than or equal to the number of dimensions (4)
# Calculate row sums
row_sums_plant <- rowSums(PAM_plant_site_final_100km)
subset_matrix_plant <- PAM_plant_site_final_100km[row_sums_plant >= 4, ]
```

```{r}
# match plant names
sp_faxes_coord_plant_sub <- sp_faxes_coord_plant[ , c("PC1", "PC2", "PC3", "PC4")]
summary(sp_faxes_coord_plant_sub)
```

```{r}
## check number of species names
nrow(sp_faxes_coord_plant_sub)
ncol(subset_matrix_plant) 
```

```{r}
sp_faxes_coord_plant_sub_names <- row.names(sp_faxes_coord_plant_sub)
subset_matrix_plant_names <- colnames(subset_matrix_plant)
```

```{r}
sp_faxes_coord_plant_sub <- as.data.frame(sp_faxes_coord_plant_sub)
row.names(sp_faxes_coord_plant_sub) <- sp_faxes_coord_plant_sub_names

sp_faxes_coord_plant_sub_names <- row.names(sp_faxes_coord_plant_sub)
subset_matrix_plant_names <- colnames(subset_matrix_plant)

plant_names <- intersect(sp_faxes_coord_plant_sub_names, subset_matrix_plant_names)
plant_names <- na.omit(plant_names)

sp_faxes_coord_plant_sub <- sp_faxes_coord_plant_sub[ which((row.names(sp_faxes_coord_plant_sub) %in% plant_names)==TRUE), ]

subset_matrix_plant  <- as.data.frame(subset_matrix_plant)
subset_matrix_plant <- subset_matrix_plant[ ,which((colnames(subset_matrix_plant) %in% plant_names)==TRUE)]

#remove NAs
sp_faxes_coord_plant_sub <- na.omit(sp_faxes_coord_plant_sub)
subset_matrix_plant <- na.omit(subset_matrix_plant)
```

```{r}
nrow(sp_faxes_coord_plant_sub)
ncol(subset_matrix_plant)
```

```{r}
sp_faxes_coord_plant_sub <- as.matrix(sp_faxes_coord_plant_sub)
subset_matrix_plant <- as.matrix(subset_matrix_plant)
```

```{r}
# Computing FD
# The number of species per assemblage has to be higher or equal to the number of traits

alpha_fd_indices_plant <- mFD::alpha.fd.multidim(sp_faxes_coord = sp_faxes_coord_plant_sub, asb_sp_w = subset_matrix_plant,
                                                     ind_vect = "fdis", details_returned = TRUE)

details_list_plant <- alpha_fd_indices_plant$"details"
```

```{r}
# Get functional dispersion
fdis_plant <- alpha_fd_indices_plant$functional_diversity_indices$fdis
```


## Mapping FD

```{r}
# Generate coordinates
subset_coords_plant <-site_loc_key_plant_100km[rowSums(PAM_plant_site_final_100km) >= 4, ]
subset_coords_plant_sp <-subset_coords_plant[,1:2 ]

plant_fd_sp <- data.frame(subset_coords_plant_sp, fdis_plant)
```

```{r}
# Convert the dataframe to sf format
spatial_fdis_plant <- st_as_sf(plant_fd_sp, coords = c("Longitude", "Latitude"))
```

```{r}
# set crs of sf objects
spatial_fdis_plant <- spatial_fdis_plant %>% st_set_crs(5389)
```

```{r}
# Extract coordinates 
spatial_fdis_plant_coords <- st_coordinates(spatial_fdis_plant)

# Add coordinates as separate columns
spatial_fdis_plant <- spatial_fdis_plant %>%
  mutate(x = spatial_fdis_plant_coords[, 1], y = spatial_fdis_plant_coords[, 2])
```

```{r}
summary(spatial_fdis_plant)
```

```{r}
TAGrid_100km <- TApoly %>%
  st_make_grid(cellsize = c(100000)) %>%
  st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
  st_cast("MULTIPOLYGON") %>%
  st_sf() %>%
  mutate(cellid = row_number())

spatial_fdis_plant$cellid <- st_intersects(spatial_fdis_plant, TAGrid_100km)$nn

spatial_fdis_plant_grid <- TAGrid_100km %>%
   st_join(spatial_fdis_plant) %>%
   group_by(cellid) %>%
   summarize(fdis_value = sum(fdis_plant, na.rm = TRUE)) %>%
   ungroup()
```


```{r}
summary(spatial_fdis_plant_grid)
```

```{r}
plantgridFDisTA_100km <-
    ggplot() +
    geom_sf(data = Americas, fill = "white")+
    geom_sf(data = TApoly, fill = "lightgrey", size = 0.1) +
    geom_sf(data = spatial_fdis_plant_grid, aes(fill = fdis_value), color = NA) +
    labs(fill = "FDis") +
    ggtitle("100 km") +
    scale_fill_distiller(palette = "Greens", direction = 1, limits = c(0,7.5)) +
    coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
    theme(panel.background = element_rect(fill = "lightblue"),
        text = element_text(size = 12), plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
plantgridFDisTA_100km
```

```{r}
ggsave("plantgridFDisTA_100km.png", plantgridFDisTA_100km, path = figure_path)
# Extract cell values
plant_cellFDis_100km <- spatial_fdis_plant_grid
hist(plant_cellFDis_100km$fdis_value)
```

## Create function to calculate FD as fdis for plants for other spatial grains
Uses inputs from trait objects created above to avoid redundancies 
```{r}
calculate_fd_as_fdis_plants <- function(PAM_site_final) {
  # Calculate row sums and subset matrix early to avoid unnecessary calculations
  row_sums_plant <- rowSums(PAM_site_final)
  subset_matrix_plant <- PAM_site_final[row_sums_plant >= 4, ]
  
  # Select the necessary columns from sp_faxes_coord_plant
  sp_faxes_coord_plant_sub <- sp_faxes_coord_plant[, c("PC1", "PC2", "PC3", "PC4")]
  
  if (nrow(sp_faxes_coord_plant_sub) != ncol(subset_matrix_plant)) {
    stop("Number of rows in sp_faxes_coord_plant_sub does not match number of columns in subset_matrix_plant")
  }
  
  sp_faxes_coord_plant_sub <- as.matrix(sp_faxes_coord_plant_sub)
  subset_matrix_plant <- as.matrix(subset_matrix_plant)
  
  # Use three fewer cores than available
  num_cores <- parallel::detectCores() - 3
  
  # Set up parallel backend
  cl <- makeCluster(num_cores)
  registerDoParallel(cl)
  
  tryCatch({
    # Define chunk size
    chunk_size <- ceiling(nrow(subset_matrix_plant) / num_cores)
    
    # Split data into chunks for parallel processing
    chunks <- split(seq_len(nrow(subset_matrix_plant)), ceiling(seq_len(nrow(subset_matrix_plant)) / chunk_size))
    
    # Process chunks in parallel
    results_list <- foreach(chunk_indices = chunks, .combine = rbind, .packages = "mFD") %dopar% {
      subset_matrix_plant_chunk <- subset_matrix_plant[chunk_indices, , drop = FALSE]
      
      alpha_fd_indices_plant <- mFD::alpha.fd.multidim(
        sp_faxes_coord = sp_faxes_coord_plant_sub, 
        asb_sp_w = subset_matrix_plant_chunk, 
        ind_vect = "fdis", 
        details_returned = TRUE
      )
     # Extract fdis values and match with corresponding cell numbers
      fdis_values <- alpha_fd_indices_plant$functional_diversity_indices$fdis
      cell_numbers <- rownames(subset_matrix_plant)[chunk_indices]
      
      # Create a data frame for this chunk
      chunk_results <- data.frame(Cell_Number = cell_numbers, fdis = fdis_values)
      chunk_results
    }
    
    # Combine all chunk results into a single data frame
    all_results <- do.call(rbind, results_list)
    
    # Stop the parallel backend
    stopCluster(cl)
    
    return(results_list)
  }, error = function(e) {
    stop("Error in parallel processing: ", conditionMessage(e))
  })
}
  
```

```{r}
fdis_plant_75km <- calculate_fd_as_fdis_plants(PAM_site_final = PAM_plant_site_final_75km)
```

```{r}
fdis_plant_50km <- calculate_fd_as_fdis_plants(PAM_site_final = PAM_plant_site_final_50km)
```

```{r}
fdis_plant_25km <- calculate_fd_as_fdis_plants(PAM_site_final = PAM_plant_site_final_25km)
```

```{r}
fdis_plant_10km <- calculate_fd_as_fdis_plants(PAM_site_final = PAM_plant_site_final_10km)
```

```{r}
fdis_plant_5km <- calculate_fd_as_fdis_plants(PAM_site_final = PAM_plant_site_final_5km)
```


## Map FD for spatial grains other than 100 km
```{r}
mapping_fd_as_fdis_plants <- function(PAM_plant_site, site_loc_key_plant, fdis_plant, resolution_meters) {
  # Generate coordinates
  subset_coords_plant <- site_loc_key_plant[rowSums(PAM_plant_site) >= 4, ]
  subset_coords_plant_sp <- subset_coords_plant[, 1:2]
  
  plant_fd_sp <- data.frame(subset_coords_plant_sp, fdis_plant)
  
  # Convert the dataframe to sf format
  spatial_fdis_plant <- st_as_sf(plant_fd_sp, coords = c("Longitude", "Latitude"))
  
  # set crs of sf objects
  spatial_fdis_plant <- spatial_fdis_plant %>% st_set_crs(5389)
  
  # Extract coordinates 
  spatial_fdis_plant_coords <- st_coordinates(spatial_fdis_plant)
  
  # Add coordinates as separate columns
  spatial_fdis_plant <- spatial_fdis_plant %>%
    mutate(x = spatial_fdis_plant_coords[, 1], y = spatial_fdis_plant_coords[, 2])
  
  # Use three fewer cores than available
  num_cores <- detectCores() - 3
  cl <- makeCluster(num_cores)
  registerDoParallel(cl)
  
  on.exit(stopCluster(cl)) # Ensure the cluster is stopped when the function exits
  
  tryCatch({
    # Generate the grid
    TAGrid <- TApoly %>%
      st_make_grid(cellsize = resolution_meters) %>%
      st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
      st_cast("MULTIPOLYGON") %>%
      st_sf() %>%
      mutate(cellid = row_number())
    
    # Check if TAGrid is empty
    if (nrow(TAGrid) == 0) {
      stop("Error: No valid grid cells after intersection.")
    }
    
    # Divide the indices of the grid into chunks for parallel processing
    chunk_indices <- split(seq_len(nrow(TAGrid)), rep(1:num_cores, each = ceiling(nrow(TAGrid) / num_cores), length.out = nrow(TAGrid)))
    
    # Process chunks in parallel
    results_list <- foreach(indices = chunk_indices, .combine = rbind, .packages = c("sf", "dplyr")) %dopar% {
      chunk <- TAGrid[indices, ]
      
      # Perform the intersection
      intersected <- st_intersection(spatial_fdis_plant, chunk)
      
      # Calculate cellid for intersected
      intersected$cellid <- st_intersects(intersected, chunk)$nn
      
      # Ensure that intersected is a data frame
      as.data.frame(intersected)
    }
    
    # Combine all chunk results into a single data frame
    spatial_fdis_plant <- do.call(rbind, results_list)
    
    # Ensure the combined result is a data frame
    spatial_fdis_plant <- as.data.frame(spatial_fdis_plant)
    
    # Debugging: Check if 'cellid' column exists
    if (!"cellid" %in% colnames(spatial_fdis_plant)) {
      stop("Error: 'cellid' column not found in spatial_fdis_plant.")
    }
    
    # Summarize fdis values per grid cell
    spatial_fdis_plant_grid <- spatial_fdis_plant %>%
      group_by(cellid) %>%
      summarize(fdis_value = sum(fdis_plant, na.rm = TRUE)) %>%
      right_join(as.data.frame(TAGrid), by = "cellid")
    
    # Convert the grid to sf
    spatial_fdis_plant_grid <- st_as_sf(spatial_fdis_plant_grid)
    
    # Create the plot
    plantgridFDisTA <- ggplot() +
      geom_sf(data = Americas, fill = "white") +
      geom_sf(data = TApoly, fill = "lightgrey", size = 0.1) +
      geom_sf(data = spatial_fdis_plant_grid, aes(fill = fdis_value), color = NA) +
      labs(fill = "FDis") +
      scale_fill_distiller(palette = "Greens", direction = 1, limits = c(0, 7.5)) +
      coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
      theme(panel.background = element_rect(fill = "lightblue"),
            text = element_text(size = 12),
            plot.title = element_text(hjust = 0.5),
            axis.text.x = element_text(angle = 45, hjust = 1))
    
    list(plantgridFDisTA = plantgridFDisTA, spatial_fdis_plant_grid = spatial_fdis_plant_grid)
  }, error = function(e) {
    message("Error in parallel processing: ", conditionMessage(e))
    NULL
  })
}
```

```{r}
mapping_75km <- mapping_fd_as_fdis_plants(PAM_plant_site_final_75km, site_loc_key_plant_75km, fdis_plant_75km$fdis, 75000)
plantgridFDisTA_75km <- mapping_75km$plantgridFDisTA
plant_cellFDis_75km <- mapping_75km$spatial_fdis_plant_grid
```

```{r}
# add title to maps
(plantgridFDisTA_75km <- plantgridFDisTA_75km +
    ggtitle("75 km")
)
ggsave("plantgridFDisTA_75km.png", plantgridFDisTA_75km, path = figure_path)
```

```{r}
mapping_50km <- mapping_fd_as_fdis_plants(PAM_plant_site_final_50km, site_loc_key_plant_50km, fdis_plant_50km$fdis, 50000)
plantgridFDisTA_50km <- mapping_50km$plantgridFDisTA
plant_cellFDis_50km <- mapping_50km$spatial_fdis_plant_grid
```

```{r}
# add title to maps
(plantgridFDisTA_50km <- plantgridFDisTA_50km +
    ggtitle("50 km")
)
ggsave("plantgridFDisTA_50km.png", plantgridFDisTA_50km, path = figure_path)
```

```{r}
mapping_25km <- mapping_fd_as_fdis_plants(PAM_plant_site_final_25km, site_loc_key_plant_25km, fdis_plant_25km$fdis, 25000)
plantgridFDisTA_25km <- mapping_25km$plantgridFDisTA
plant_cellFDis_25km <- mapping_25km$spatial_fdis_plant_grid
```

```{r}
# add title to maps
(plantgridFDisTA_25km <- plantgridFDisTA_25km +
    ggtitle("25 km")
)
ggsave("plantgridFDisTA_25km.png", plantgridFDisTA_25km, path = figure_path)
```

```{r}
mapping_10km <- mapping_fd_as_fdis_plants(PAM_plant_site_final_10km, site_loc_key_plant_10km, fdis_plant_10km$fdis, 10000)
plantgridFDisTA_10km <- mapping_10km$plantgridFDisTA
plant_cellFDis_10km <- mapping_10km$spatial_fdis_plant_grid
```

```{r}
# add title to maps
(plantgridFDisTA_10km <- plantgridFDisTA_10km +
    ggtitle("10 km")
)
ggsave("plantgridFDisTA_10km.png", plantgridFDisTA_10km, path = figure_path)
```

```{r}
# Generate coordinates
subset_coords_plant_5km <-site_loc_key_plant_5km[rowSums(PAM_plant_site_final_5km) >= 4, ]
subset_coords_plant_sp_5km <-subset_coords_plant_5km[,1:2 ]

plant_fd_sp_5km <- data.frame(subset_coords_plant_sp_5km, fdis_plant_5km)
```

```{r}
# Convert the dataframe to sf format
spatial_fdis_plant_5km <- st_as_sf(plant_fd_sp_5km, coords = c("Longitude", "Latitude"))
```

```{r}
# set crs of sf objects
spatial_fdis_plant_5km <- spatial_fdis_plant_5km %>% st_set_crs(5389)
```

```{r}
# Extract coordinates 
spatial_fdis_plant_coords_5km <- st_coordinates(spatial_fdis_plant_5km)

# Add coordinates as separate columns
spatial_fdis_plant_5km <- spatial_fdis_plant_5km %>%
  mutate(x = spatial_fdis_plant_coords_5km[, 1], y = spatial_fdis_plant_coords_5km[, 2])
```

```{r}
summary(spatial_fdis_plant_5km)
```

```{r}
TAGrid_5km <- TApoly %>%
  st_make_grid(cellsize = c(5000)) %>%
  st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
  st_cast("MULTIPOLYGON") %>%
  st_sf() %>%
  mutate(cellid = row_number())

spatial_fdis_plant_5km$cellid <- st_intersects(spatial_fdis_plant_5km, TAGrid_5km)$nn

```

```{r}
# Determine number of cores to use
num_cores <- detectCores() - 2

# Register parallel backend
cl <- makeCluster(num_cores)
registerDoParallel(cl)

# Ensure the cluster stops when done
on.exit(stopCluster(cl))

# Split TAGrid_5km indices into chunks for parallel processing
chunk_indices <- split(seq_len(nrow(TAGrid_5km)), rep(1:num_cores, each = ceiling(nrow(TAGrid_5km) / num_cores), length.out = nrow(TAGrid_5km)))

# Perform spatial join and aggregation in parallel
results_list <- foreach(indices = chunk_indices, .combine = 'c', .packages = c("sf", "dplyr")) %dopar% {
  grid_chunk <- TAGrid_5km[indices, ]
  
  # Perform spatial join
  joined <- st_join(grid_chunk, spatial_fdis_plant)
  
  # Group by cellid and summarize fdis values
  summarized <- joined %>%
    group_by(cellid) %>%
    summarize(fdis_value = sum(fdis_plant, na.rm = TRUE)) %>%
    ungroup()
  
  # Ensure that summarized is a data frame and add debugging information
  summarized_df <- as.data.frame(summarized)
  
  # Debugging: Check the structure of the summarized data frame
  message("Processed chunk: ", indices[1], " to ", indices[length(indices)])
  str(summarized_df)
  
  list(summarized_df)  # Return as list to avoid unintended simplification
}

# Flatten the results_list and ensure each element is a data frame
flattened_results <- map_dfr(results_list, ~ as.data.frame(.x))

# Check the structure of the combined result
str(flattened_results)

# Convert to sf object if applicable
if ("geometry" %in% colnames(flattened_results)) {
  spatial_fdis_plant_grid <- st_as_sf(flattened_results)
} else {
  spatial_fdis_plant_grid <- flattened_results
}

# Check the structure of the final output
str(spatial_fdis_plant_grid)

```

```{r}
plantgridFDisTA_5km <-
    ggplot() +
    geom_sf(data = Americas, fill = "white")+
    geom_sf(data = TApoly, fill = "lightgrey", size = 0.1) +
    geom_sf(data = spatial_fdis_plant_grid, aes(fill = fdis_value), color = NA) +
    labs(fill = "FDis") +
    ggtitle("5 km") +
    scale_fill_distiller(palette = "Greens", direction = 1, limits = c(0,6.5)) +
    coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
    theme(panel.background = element_rect(fill = "lightblue"),
        text = element_text(size = 12), plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1))
plantgridFDisTA_5km
```

```{r}
plant_cellFDis_5km <- spatial_fdis_plant_grid
```

```{r}
# add title to maps
(plantgridFDisTA_5km <- plantgridFDisTA_5km +
    ggtitle("5 km")
)
ggsave("plantgridFDisTA_5km.png", plantgridFDisTA_5km, path = figure_path)
```

# Multi panel plots of FD maps
## Make sure all plots for the same taxa have the same legend scale
```{r}
plant_plot_legend <- function(plot){
  plot + scale_fill_distiller(palette = "Greens", direction = 1,limits = c(0, 6.5),
                              oob = scales::squish, breaks = seq(0, 6.5, by = 1)) +
    theme(legend.key.height = unit(0.5, "in"), legend.text = element_text(size = 10)) +
      annotation_scale(location = "bl", width_hint = 0.5)
}
frugivore_plot_legend <- function(plot){
  plot + scale_fill_distiller(palette = "YlOrBr", direction = 1,limits = c(0, 8.5),
                              oob = scales::squish, breaks = seq(0, 8.5, by = 1)) +
    theme(legend.key.height = unit(0.5, "in"), legend.text = element_text(size = 10)) +
      annotation_scale(location = "bl", width_hint = 0.5)
}
```

```{r}
(plantgridFDisTA_100km <- plant_plot_legend(plantgridFDisTA_100km))
(plantgridFDisTA_75km <- plant_plot_legend(plantgridFDisTA_75km))
(plantgridFDisTA_50km <- plant_plot_legend(plantgridFDisTA_50km))
(plantgridFDisTA_25km <- plant_plot_legend(plantgridFDisTA_25km))
(plantgridFDisTA_10km <- plant_plot_legend(plantgridFDisTA_10km))
(plantgridFDisTA_5km <- plant_plot_legend(plantgridFDisTA_5km))
```

```{r}
(frugivoregridFDisTA_100km <- frugivore_plot_legend(frugivoregridFDisTA_100km))
(frugivoregridFDisTA_75km <- frugivore_plot_legend(frugivoregridFDisTA_75km))
(frugivoregridFDisTA_50km <- frugivore_plot_legend(frugivoregridFDisTA_50km))
(frugivoregridFDisTA_25km <- frugivore_plot_legend(frugivoregridFDisTA_25km))
(frugivoregridFDisTA_10km <- frugivore_plot_legend(frugivoregridFDisTA_10km))
(frugivoregridFDisTA_5km <- frugivore_plot_legend(frugivoregridFDisTA_5km))
```

## Plants
```{r}
# Arrange the plots with common legend
all_plant_fdis_plots <- ggarrange(plantgridFDisTA_5km, plantgridFDisTA_10km,
                                      plantgridFDisTA_25km, plantgridFDisTA_50km,
                                      plantgridFDisTA_75km, plantgridFDisTA_100km,
                                      ncol = 6, nrow = 1,
                                      common.legend = TRUE, legend = "left")

all_plant_fdis_plots
```

```{r}
all_plant_fdis_plots_labeled <- ggpubr::annotate_figure(all_plant_fdis_plots,
                                                            left = ggpubr::text_grob("Plants", face = "bold", size = 20, 
                                                                                     rot = 90))
all_plant_fdis_plots_labeled
ggsave("plant_fdis_plots.png", all_plant_fdis_plots_labeled, path = figure_path, width = 16, height = 5, units = "in")
```

## Frugivores
```{r}
all_frugivore_fdis_plots <- ggpubr::ggarrange(frugivoregridFDisTA_5km,frugivoregridFDisTA_10km,
                                                  frugivoregridFDisTA_25km, frugivoregridFDisTA_50km,
                                                  frugivoregridFDisTA_75km, frugivoregridFDisTA_100km,
                                                  ncol = 6, nrow = 1,
                                                  common.legend = TRUE, legend = "left")
all_frugivore_fdis_plots
```

```{r}
all_frugivore_fdis_plots_labeled <- ggpubr::annotate_figure(all_frugivore_fdis_plots,
                                                            left = ggpubr::text_grob("Frugivores", face = "bold", size = 20,
                                                                                     rot = 90))
all_frugivore_fdis_plots_labeled
ggsave("frugivore_fdis_plots.png", all_frugivore_fdis_plots_labeled, path = figure_path, width = 16, height = 5, units = "in")
```

## Combine plants & frugivores
```{r}
all_fdis_plots <- ggpubr::ggarrange(all_plant_fdis_plots_labeled,
                                        all_frugivore_fdis_plots_labeled,
                                        ncol = 1, nrow = 2)
# Add a white background to the plot
all_fdis_plots <- all_fdis_plots + theme(plot.background = element_rect(fill = "white", color = NA))
all_fdis_plots

ggsave("all_fdis_plots.png", all_fdis_plots, path = figure_path, width = 16, height = 10, units = "in")
```

# Write data to csv
Have to remove geometry before saving to csv
```{r}
plant_cellFDis_5km_df <- data.frame(cellid = plant_cellFDis_5km$fdis_value,
                                        fdis_value = plant_cellFDis_5km$fdis_value)
frugivore_cellFDis_5km_df <- data.frame(cellid = frugivore_cellFDis_5km$fdis_value,
                                        fdis_value = frugivore_cellFDis_5km$fdis_value)

plant_cellFDis_10km_df <- data.frame(cellid = plant_cellFDis_10km$fdis_value,
                                        fdis_value = plant_cellFDis_10km$fdis_value)
frugivore_cellFDis_10km_df <- data.frame(cellid = frugivore_cellFDis_10km$fdis_value,
                                        fdis_value = frugivore_cellFDis_10km$fdis_value)

plant_cellFDis_25km_df <- data.frame(cellid = plant_cellFDis_25km$fdis_value,
                                        fdis_value = plant_cellFDis_25km$fdis_value)
frugivore_cellFDis_25km_df <- data.frame(cellid = frugivore_cellFDis_25km$fdis_value,
                                        fdis_value = frugivore_cellFDis_25km$fdis_value)

plant_cellFDis_50km_df <- data.frame(cellid = plant_cellFDis_50km$fdis_value,
                                        fdis_value = plant_cellFDis_50km$fdis_value)
frugivore_cellFDis_50km_df <- data.frame(cellid = frugivore_cellFDis_50km$fdis_value,
                                        fdis_value = frugivore_cellFDis_50km$fdis_value)

plant_cellFDis_75km_df <- data.frame(cellid = plant_cellFDis_75km$fdis_value,
                                        fdis_value = plant_cellFDis_75km$fdis_value)
frugivore_cellFDis_75km_df <- data.frame(cellid = frugivore_cellFDis_75km$fdis_value,
                                        fdis_value = frugivore_cellFDis_75km$fdis_value)

plant_cellFDis_100km_df <- data.frame(cellid = plant_cellFDis_100km$fdis_value,
                                        fdis_value = plant_cellFDis_100km$fdis_value)
frugivore_cellFDis_100km_df <- data.frame(cellid = frugivore_cellFDis_100km$fdis_value,
                                        fdis_value = frugivore_cellFDis_100km$fdis_value)
```

```{r}
write.csv(plant_cellFDis_5km_df, file.path(output_path,"TropicalAndes_plantFDis_5km.csv"), row.names = FALSE)
write.csv(frugivore_cellFDis_5km_df, file.path(output_path,"TropicalAndes_frugivoreFDis_5km.csv"), row.names = FALSE)
```

```{r}
write.csv(plant_cellFDis_10km_df, file.path(output_path,"TropicalAndes_plantFDis_10km.csv"), row.names = FALSE)
write.csv(frugivore_cellFDis_10km_df, file.path(output_path,"TropicalAndes_frugivoreFDis_10km.csv"), row.names = FALSE)
```

```{r}
write.csv(plant_cellFDis_25km_df, file.path(output_path,"TropicalAndes_plantFDis_25km.csv"), row.names = FALSE)
write.csv(frugivore_cellFDis_25km_df, file.path(output_path,"TropicalAndes_frugivoreFDis_25km.csv"), row.names = FALSE)
```

```{r}
write.csv(plant_cellFDis_50km_df, file.path(output_path,"TropicalAndes_plantFDis_50km.csv"), row.names = FALSE)
write.csv(frugivore_cellFDis_50km_df, file.path(output_path,"TropicalAndes_frugivoreFDis_50km.csv"), row.names = FALSE)
```

```{r}
write.csv(plant_cellFDis_75km_df, file.path(output_path,"TropicalAndes_plantFDis_75km.csv"), row.names = FALSE)
write.csv(frugivore_cellFDis_75km_df, file.path(output_path,"TropicalAndes_frugivoreFDis_75km.csv"), row.names = FALSE)
```

```{r}
write.csv(plant_cellFDis_100km_df, file.path(output_path,"TropicalAndes_plantFDis_100km.csv"), row.names = FALSE)
write.csv(frugivore_cellFDis_100km_df, file.path(output_path,"TropicalAndes_frugivoreFDis_100km.csv"), row.names = FALSE)
```
