---
title: "Tropical Andes Taxonomic Diversity of Plants and Frugivores"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: "Calculating and mapping taxonomic diversity as species richness using occurrence data for plants and frugivores in the Tropical Andes Moist Lowland and Montane forests. Note: some code is adapted from https://luisdva.github.io/rstats/richness/."
data input: "TropicalAndes_plant_occ.csv, TropicalAndes_frugivore_occ.csv"
data output: "TropicalAndes_frugivore_richness.csv, TropicalAndes_GBIF_plant_richness.csv"
date: "2023-08-01"
output: html_document
---

# Load required packages
```{r}
library(sf)
library(dplyr)
library(ggplot2)
library(rnaturalearth)
library(smoothr)
library(purrr)
library(raster)
library(ggspatial)
library(ggpubr)
```

# Set file paths
```{r}
data_path_L0<-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
data_path_L1 <-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
output_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L2')
```

# Read in Data
```{r}
## projected sf objects
plants_sf_species <- readRDS(file = file.path(data_path_L1,"plants_sf_species.rds"))
frugivores_sf_species <- readRDS(file = file.path(data_path_L1,"frugivores_sf_species.rds"))
Americas <- readRDS(file = file.path(data_path_L1, "Americas.rds"))
TApoly <- readRDS(file = file.path(data_path_L1,"TApoly.rds"))
TropicalAndes_IUCNHabitat_Forest <- readRDS(file = file.path(data_path_L1,"TropicalAndes_IUCNHabitat_Forest.rds"))
```

# Plot TD/Richness
## Function for richness plots
```{r}
create_rich_plots <- function(resolution_meters) {
 # Make Grid
  TAGrid <- TApoly %>%
    st_make_grid(cellsize = c(resolution_meters)) %>%
    st_intersection(TropicalAndes_IUCNHabitat_Forest) %>%
    st_cast("MULTIPOLYGON") %>%
    st_sf() %>%
    mutate(cellid = row_number())

  # Calculate cell richness for plants
  plant_richness_grid <- TAGrid %>%
    st_join(plants_sf_species) %>%
    mutate(overlap = ifelse(!is.na(species), 1, 0)) %>%
    group_by(cellid) %>%
    summarize(num_species = sum(overlap))

  # Calculate cell richness for frugivores
  frugivore_richness_grid <- TAGrid %>%
    st_join(frugivores_sf_species) %>%
    mutate(overlap = ifelse(!is.na(species), 1, 0)) %>%
    group_by(cellid) %>%
    summarize(num_species = sum(overlap))

  # Helper functions to generate plots
  generate_plant_plot <- function(data) {
    ggplot(data) +
      geom_sf(data = Americas, fill = "white") +
      geom_sf(data = TApoly, fill = "grey", size = 0.1) +
      geom_sf(aes(fill = num_species), color = NA) +
      scale_fill_distiller(palette = "Greens", direction = 1, limits = c(0,6000)) +
      labs( x = "Longitude", y = "Latitude", fill = "Number of species") +
      coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
      annotation_scale(location = "bl", width_hint = 0.5)  +
      theme(panel.background = element_rect(fill = "lightblue"))
  }
  generate_frugivore_plot <- function(data) {
    ggplot(data) +
      geom_sf(data = Americas, fill = "white") +
      geom_sf(data = TApoly, fill = "grey", size = 0.1) +
      geom_sf(aes(fill = num_species), color = NA) +
      scale_fill_distiller(palette = "YlOrBr", direction = 1, limits = c(0,500)) + 
      labs(x = "Longitude", y = "Latitude", fill = "Number of species") +
      coord_sf(xlim = c(-82, -60), ylim = c(-24, 14), expand = FALSE, crs = 4326) +
      annotation_scale(location = "bl", width_hint = 0.5)  +
      theme(panel.background = element_rect(fill = "lightblue"))
  }

  # Generate plots
  plant_plot <- generate_plant_plot(plant_richness_grid)
  frugivore_plot <- generate_frugivore_plot(frugivore_richness_grid)

  # Extract cell values
  comparison_data <- data.frame(Plant_Richness = plant_richness_grid$num_species,
                               Frugivore_Richness = frugivore_richness_grid$num_species)
  
  # Filter out rows where either plant or frugivore richness is zero
  comparison_data_filtered <- comparison_data %>%
                                filter(Plant_Richness > 0 & Frugivore_Richness > 0)

  # Create histograms
  plant_richness_hist <- hist(comparison_data$Plant_Richness, 
    main = paste("Histogram of Plant Richness [", resolution_meters/1000, " km] by cell", sep = ""),
                              xlab = "Plant Richness by cell")
  frugivore_richness_hist <- hist(comparison_data$Frugivore_Richness,
    main = paste("Histogram of Frugivore Richness [", resolution_meters/1000, " km] by cell", sep = ""),
                                  xlab = "Frugivore Richness by cell")
  # Return a list of data
  list(plantgridRichTA = plant_plot,
       frugivoregridRichTA = frugivore_plot,
       plant_cellRichness = plant_richness_grid,
       frugivore_cellRichness = frugivore_richness_grid, 
       comparison_data_filtered = comparison_data_filtered,
       plant_richness_hist = plant_richness_hist,
       frugivore_richness_hist = frugivore_richness_hist)
}

```


## 1 km resolution
```{r}
richness_1km <- create_rich_plots(1000)
print(richness_1km)

# save plots
plantgridRichTA_1km <- richness_1km$plant_plot
frugivoregridRichTA_1km <- richness_1km$frugivoregridRichTA
# save richness data
plant_cellRichness_1km <- richness_1km$plant_cellRichness
frugivore_cellRichness_1km <- richness_1km$frugivore_cellRichness

comparison_data_filtered_1km <- richness_1km$comparison_data_filtered
```

```{r}

```

## 5 km resolution
```{r}
richness_5km <- create_rich_plots(5000)
print(richness_5km)

# save plots
plantgridRichTA_5km <- richness_5km$plantgridRichTA
frugivoregridRichTA_5km <- richness_5km$frugivoregridRichTA
## Extract cell values
plant_cellRichness_5km <- richness_5km$plant_cellRichness
frugivore_cellRichness_5km <- richness_5km$frugivore_cellRichness

comparison_data_filtered_5km <- richness_5km$comparison_data_filtered
```

```{r}

```

## 10 km
```{r}
richness_10km <- create_rich_plots(10000)
print(richness_10km)

# save plots
plantgridRichTA_10km <- richness_10km$plantgridRichTA
frugivoregridRichTA_10km <- richness_10km$frugivoregridRichTA
## Extract cell values
plant_cellRichness_10km <- richness_10km$plant_cellRichness
frugivore_cellRichness_10km <- richness_10km$frugivore_cellRichness

comparison_data_filtered_10km <- richness_10km$comparison_data_filtered
```

```{r}

```

## 25 km
```{r}
richness_25km <- create_rich_plots(25000)
print(richness_25km)

# save plots
plantgridRichTA_25km <- richness_25km$plantgridRichTA
frugivoregridRichTA_25km <- richness_25km$frugivoregridRichTA
## Extract cell values
plant_cellRichness_25km <- richness_25km$plant_cellRichness
frugivore_cellRichness_25km <- richness_25km$frugivore_cellRichness

comparison_data_filtered_25km <- richness_25km$comparison_data_filtered
```

```{r}

```

## 50 km
```{r}
richness_50km <- create_rich_plots(50000)
print(richness_50km)
# save plots
plantgridRichTA_50km <- richness_50km$plantgridRichTA
frugivoregridRichTA_50km <- richness_50km$frugivoregridRichTA
## Extract cell values
plant_cellRichness_50km <- richness_50km$plant_cellRichness
frugivore_cellRichness_50km <- richness_50km$frugivore_cellRichness

comparison_data_filtered_50km <- richness_50km$comparison_data_filtered
```

```{r}

```

## 75 km 
```{r}
richness_75km <- create_rich_plots(75000)
print(richness_75km)
# save plots
plantgridRichTA_75km <- richness_75km$plantgridRichTA
frugivoregridRichTA_75km <- richness_75km$frugivoregridRichTA
## Extract cell values
plant_cellRichness_75km <- richness_75km$plant_cellRichness
frugivore_cellRichness_75km <- richness_75km$frugivore_cellRichness

comparison_data_filtered_75km <- richness_75km$comparison_data_filtered
```

```{r}

```

## 100 km 
```{r}
richness_100km <- create_rich_plots(100000)
print(richness_100km)
# save plots
plantgridRichTA_100km <- richness_100km$plantgridRichTA
frugivoregridRichTA_100km <- richness_100km$frugivoregridRichTA
## Extract cell values
plant_cellRichness_100km <- richness_100km$plant_cellRichness
frugivore_cellRichness_100km <- richness_100km$frugivore_cellRichness

comparison_data_filtered_100km <- richness_100km$comparison_data_filtered
```

```{r}

```

```{r}
# Compare plant and frugivore richness
  ## Fit a linear model
  compare_richness_linear_summary_100km <- summary(lm(comparison_data_filtered_100km$Frugivore_Richness ~
                                                  comparison_data_filtered_100km$Plant_Richness))
  linear_r_squared_100km <- compare_richness_linear_summary_100km$r.squared
  
  ## Fit an exponential model
  compare_richness_exponential_summary_100km <- summary(lm(comparison_data_filtered_100km$Frugivore_Richness ~
                                                       log(comparison_data_filtered_100km$Plant_Richness)))
  exponential_r_squared_100km <- compare_richness_exponential_summary_100km$r.squared

  ## Create scatter plot with linear and exponential lines
  compare_richness_plot_100km <- ggplot(comparison_data_filtered_100km,
                                        aes(x = Plant_Richness, y = Frugivore_Richness)) +
  geom_point() +
  labs(title = paste("Plant Richness vs Frugivore Richness [", resolution_meters/1000, " km]", sep = ""),
       subtitle =  paste("Linear (Red) R-squared = ", round(linear_r_squared, 2), "\n",
                  "Exponential (Blue) R-squared = ", round(exponential_r_squared, 2)),
       x = "Plant Richness by cell", y = "Frugivore Richness by cell") +
  geom_smooth(method = "lm", se = FALSE, color = "red")+
  geom_smooth(method = "lm", se = FALSE, color = "blue", formula = y ~ log(x)) +
  coord_cartesian(xlim = c(0, NA), ylim = c(0, NA))
```


```{r}
# Fit the nonlinear model using nls
nls_model <- nls(Frugivore_Richness ~ b * exp(c * Plant_Richness), 
                 data = comparison_data_filtered_100km, 
                 start = list(b = 200, c = -0.00001),
                 algorithm = "port",
                 control = nls.control(maxiter = 500, minFactor = 1e-10, warnOnly = TRUE))

# Summary of the model
summary(nls_model)
```


# Multi panel plots
Richness maps
```{r}
all_richness_plots <- ggpubr::ggarrange(#plantgridRichTA_1km, plantgridRichTA_5km, 
                                              plantgridRichTA_10km, plantgridRichTA_25km,
                                              plantgridRichTA_50km, plantgridRichTA_75km,
                                              plantgridRichTA_100km,
                                              #frugivoregridRichTA_1km, frugivoregridRichTA_5km, 
                                              frugivoregridRichTA_10km, frugivoregridRichTA_25km,
                                              frugivoregridRichTA_50km, frugivoregridRichTA_75km,
                                              frugivoregridRichTA_100km, 
                                              ncol = 5, nrow = 2,
                                              labels = c("10km", "25km", ))
all_richness_plots
ggsave("all_richness_plots.pdf", all_richness_plots, path = output_path, width = 20, height = 8.5, units = "in")
```

# Compare r-squared by resolution
Plot
```{r}
# create dataframe of resolutions and r-squared values 
#[ADD 1, 5,]
resolution <- c( 10, 25, 50, 75, 100)
#ADD compare_richness_r2_1km, compare_richness_r2_5km,
r_squared <- c(compare_richness_r2_10km, compare_richness_r2_25km, compare_richness_r2_50km, compare_richness_r2_75km, compare_richness_r2_100km)
r_squared_compare <- data.frame(resolution, r_squared)

compare_r2_by_res <- ggplot(r_squared_compare, aes(x=resolution, y=r_squared)) +
    geom_point()+
    labs(title = "R-squared values of plant-frugivore richness relationships by resolution",
         x = "Resolution (km)", y = "R-squared", fill = "Number of species")
print(compare_r2_by_res)
```




# Write data to csv
```{r}
write.csv(plant_cellRichness_1km, file.path(output_path,"TropicalAndes_plantRichness_1km.csv"))
write.csv(frugivore_cellRichness_1km, file.path(output_path,"TropicalAndes_frugivoreRichness_1km.csv"))
```

```{r}
write.csv(plant_cellRichness_5km, file.path(output_path,"TropicalAndes_plantRichness_5km.csv"))
write.csv(frugivore_cellRichness_5km, file.path(output_path,"TropicalAndes_frugivoreRichness_5km.csv"))
```

```{r}
write.csv(plant_cellRichness_10km, file.path(output_path,"TropicalAndes_plantRichness_10km.csv"))
write.csv(frugivore_cellRichness_10km, file.path(output_path,"TropicalAndes_frugivoreRichness_10km.csv"))
```

```{r}
write.csv(plant_cellRichness_25km, file.path(output_path,"TropicalAndes_plantRichness_25km.csv"))
write.csv(frugivore_cellRichness_25km, file.path(output_path,"TropicalAndes_frugivoreRichness_25km.csv"))
```

```{r}
write.csv(plant_cellRichness_50km, file.path(output_path,"TropicalAndes_plantRichness_50km.csv"))
write.csv(frugivore_cellRichness_50km, file.path(output_path,"TropicalAndes_frugivoreRichness_50km.csv"))
```

```{r}
write.csv(plant_cellRichness_75km, file.path(output_path,"TropicalAndes_plantRichness_75km.csv"))
write.csv(frugivore_cellRichness_75km, file.path(output_path,"TropicalAndes_frugivoreRichness_75km.csv"))
```

```{r}
write.csv(plant_cellRichness_100km, file.path(output_path,"TropicalAndes_plantRichness_100km.csv"))
write.csv(frugivore_cellRichness_100km, file.path(output_path,"TropicalAndes_frugivoreRichness_100km.csv"))
```
