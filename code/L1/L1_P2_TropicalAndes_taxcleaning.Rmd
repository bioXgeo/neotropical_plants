---
title: "Tropical Andes plant Lookup Table"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: ""
data input: ""
data output: ""
date: "2023-07-25"
output: html_document
---

# Load required packages
```{r}
library(knitr)
library(TNRS)
library(bdc)
library(dplyr)
```

# Set file paths
```{r}
data_path_L0<-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
data_path_L1 <-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
output_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
```

# Read in data
```{r}
GBIF_occ <- read.csv(file.path(data_path_L1, "TropicalAndes_GBIF_plant_occ_cleaned.csv"))
TRY_traits <- read.csv(file.path(data_path_L0,"TropicalAndes_TRY_plant_traits.csv"))
BIEN_traits <- read.csv(file.path(data_path_L0,"AllDesired_BIEN_plant_traits.csv"))
GIFT_traits <- read.csv(file.path(data_path_L0,"TropicalAndes_GIFT_plant_traits.csv"))
```

# Generate species lists
```{r}
GBIF_species <- unique(GBIF_occ$species)
TRY_species <- unique(TRY_traits$SpeciesName)
BIEN_species <- unique(BIEN_traits$scrubbed_species_binomial)
GIFT_species <- unique(GIFT_traits$species)
```

```{r}
length(GBIF_species)
length(TRY_species)
length(BIEN_species)
length(GIFT_species)
```
## combine species list together
```{r}
all_species <- c(GBIF_species, TRY_species, BIEN_species, GIFT_species)
all_species <- unique(all_species)
length(all_species)
```
# Remove NAs
```{r}
all_species <- all_species[!is.na(all_species)]
length(all_species)
```

# Use Rocc to check scientific names 
Adapted from tutorial https://liibre.github.io/Rocc/articles/articles/check_taxa.html
```{r}
name_check_results <- bdc_clean_names(sci_names = all_species, save_outputs = FALSE)
```
```{r}
all_species_cleaned <- name_check_results$names_clean
```


# Using TNRS to get harmonize taxonomy

```{r}
all_species_hamonized_results <- TNRS(taxonomic_names = all_species_cleaned)
```


# Subset TNRS results to species with matches, conflicts, and disparties
```{r}
unique(all_species_hamonized_results$Taxonomic_status)
```


```{r}
all_species_matches <- subset(all_species_hamonized_results, Taxonomic_status == "Accepted")
nrow(all_species_matches)
all_species_conflicts <- subset(all_species_hamonized_results, Taxonomic_status == "Synonym")
nrow(all_species_conflicts)

# Disparties
all_species_no.opinion <- subset(all_species_hamonized_results, Taxonomic_status == "No opinion")
nrow(all_species_no.opinion)
all_species_illegitimate <- subset(all_species_hamonized_results, Taxonomic_status == "Illegitimate")
nrow(all_species_illegitimate)
all_species_invalid <- subset(all_species_hamonized_results, Taxonomic_status == "Invalid")
nrow(all_species_invalid)
all_species_other <- subset(all_species_hamonized_results, Taxonomic_status == "")
nrow(all_species_other)
```
# Create species list of names with disparities
```{r}
all_species_disparities <- all_species_hamonized_results %>%
                            filter(Taxonomic_status %in% c("No opinion", "Illegitimate", "Invalid", "")) %>%
                            select(Name_submitted)
```

# Use bdc to harmonize disparities
## Using ITIS database
```{r}
all_species_disparities_col_results <- bdc_query_names_taxadb(sci_name = all_species_disparities$Name_submitted, replace_synonyms = TRUE,suggest_names = TRUE, db = "col", rank_name = "Plantae", rank = "kingdom")
```

## Subset COL results to accepted, synonym, and NA

```{r}
unique(all_species_disparities_col_results$taxonomicStatus)
```

```{r}
all_species_col_accepted <- subset(all_species_disparities_col_results, taxonomicStatus == "accepted")
nrow(all_species_col_accepted)
all_species_col_synonym <- subset(all_species_disparities_col_results, taxonomicStatus == "synonym")
nrow(all_species_col_synonym)
all_species_col_NA <- subset(all_species_disparities_col_results, is.na(taxonomicStatus))
nrow(all_species_col_NA)
```

# Create lookup table
## From TNRS
```{r}
species_matches <- all_species_matches[ , c("Name_submitted", "Name_matched", "Source")]
species_corrected <- all_species_conflicts[ , c("Name_submitted", "Name_matched", "Source")]
```

## From bdc using COL
```{r}
species_col_accepted <- all_species_col_accepted[ , c("original_search", "suggested_name")]
species_col_accepted$source <- c("col")
species_col_synonmyn <- all_species_col_synonym[ , c("original_search", "suggested_name")]
species_col_synonmyn$source <- c("col")
```


```{r}
# combine to create lookup table
lookup_table <- rbind(species_matches, species_corrected)
```

# Save lookup table as csv
```{r}

```

# Update data files species names using lookup table
```{r}

```

# Write data to csv
```{r}

```

