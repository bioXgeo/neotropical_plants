---
title: "Tropical Andes plant Lookup Table"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: ""
data input: ""
data output: ""
date: "2023-07-25"
output: 
  html_document: 
    toc: yes
    df_print: tibble
---

# Load required packages
```{r}
library(knitr)
library(TNRS)
library(bdc)
library(dplyr)
```

# Set file paths
```{r}
data_path_L0<-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L0')
data_path_L1 <-file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
output_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
```

# Read in data
```{r}
GBIF_occ <- read.csv(file.path(data_path_L1, "TropicalAndes_GBIF_plant_occ_cleaned.csv"))
TRY_traits <- read.csv(file.path(data_path_L0,"TropicalAndes_TRY_plant_traits.csv"))
BIEN_traits <- read.csv(file.path(data_path_L0,"AllDesired_BIEN_plant_traits.csv"))
GIFT_traits <- read.csv(file.path(data_path_L0,"TropicalAndes_GIFT_plant_traits.csv"))
```

# Generate species lists
```{r}
GBIF_species <- unique(GBIF_occ$species)
TRY_species <- unique(TRY_traits$SpeciesName)
BIEN_species <- unique(BIEN_traits$scrubbed_species_binomial)
GIFT_species <- unique(GIFT_traits$species)
```

```{r}
length(GBIF_species)
length(TRY_species)
length(BIEN_species)
length(GIFT_species)
```
## combine species list together
```{r}
all_species <- c(GBIF_species, TRY_species, BIEN_species, GIFT_species)
all_species <- unique(all_species)
length(all_species)
```
# Remove NAs
```{r}
all_species <- all_species[!is.na(all_species)]
length(all_species)
```

# Use bdc to check scientific names 
```{r}
name_check_results <- bdc_clean_names(sci_names = all_species, save_outputs = FALSE)
```
```{r}
all_species_cleaned <- name_check_results$names_clean
length(all_species_cleaned)
```


# Using TNRS to get harmonize taxonomy

```{r}
all_species_hamonized_results <- TNRS(taxonomic_names = all_species_cleaned)
```


# Subset TNRS results to species with matches, conflicts, and disparties
```{r}
nrow(all_species_hamonized_results)
unique(all_species_hamonized_results$Taxonomic_status)
```


```{r}
all_species_matches <- subset(all_species_hamonized_results, Taxonomic_status == "Accepted")
nrow(all_species_matches)
all_species_conflicts <- subset(all_species_hamonized_results, Taxonomic_status == "Synonym")
nrow(all_species_conflicts)

# Disparties
all_species_no.opinion <- subset(all_species_hamonized_results, Taxonomic_status == "No opinion")
nrow(all_species_no.opinion)
all_species_illegitimate <- subset(all_species_hamonized_results, Taxonomic_status == "Illegitimate")
nrow(all_species_illegitimate)
all_species_invalid <- subset(all_species_hamonized_results, Taxonomic_status == "Invalid")
nrow(all_species_invalid)
all_species_other <- subset(all_species_hamonized_results, Taxonomic_status == "")
nrow(all_species_other)
```
# Create species list of names with disparities
```{r}
all_species_disparities <- all_species_hamonized_results %>%
                            filter(Taxonomic_status %in% c("No opinion", "Illegitimate", "Invalid", "")) %>%
                            select(Name_submitted)
nrow(all_species_disparities)
```


# Use bdc to harmonize disparities
## Using COL database
```{r}
all_species_disparities_col_results <- bdc_query_names_taxadb(sci_name = all_species_disparities$Name_submitted, replace_synonyms = TRUE,suggest_names = TRUE, db = "col", rank_name = "Plantae", rank = "kingdom")
```

## Subset COL results to accepted, synonym, and NA
```{r}
unique(all_species_disparities_col_results$taxonomicStatus)
```

```{r}
all_species_col_accepted <- subset(all_species_disparities_col_results, taxonomicStatus == "accepted")
nrow(all_species_col_accepted)
all_species_col_synonym <- subset(all_species_disparities_col_results, taxonomicStatus == "synonym")
nrow(all_species_col_synonym)
all_species_col_NA <- subset(all_species_disparities_col_results, is.na(taxonomicStatus))
nrow(all_species_col_NA)
```

# Create list of species still unharmonized
```{r}
unresolved_species <- all_species_col_NA$original_search
```


# Create lookup table
## From TNRS
```{r}
species_matches <- all_species_matches[ , c("Name_submitted", "Accepted_species", "Source")]
species_corrected <- all_species_conflicts[ , c("Name_submitted", "Accepted_species", "Source")]
```

```{r}
#combine
lookup_table_TNRS <- rbind(species_matches, species_corrected)
lookup_table_TNRS$harmonization_package <- c("TNRS")
```


## From bdc using COL
```{r}
species_col_accepted <- all_species_col_accepted[ , c("original_search", "scientificName")]
species_col_accepted$source <- c("col")
species_col_synonmyn <- all_species_col_synonym[ , c("original_search", "scientificName")]
species_col_synonmyn$source <- c("col")
```

```{r}
#update col names
colnames(species_col_accepted) <- c("Name_submitted", "Accepted_species", "Source")
colnames(species_col_synonmyn) <- c("Name_submitted", "Accepted_species", "Source")
```

```{r}
#combine
lookup_table_bdc <- rbind(species_col_accepted, species_col_synonmyn)
lookup_table_bdc$harmonization_package <- c("bdc")
```


## Combine to create lookup table
```{r}
lookup_table <- rbind(lookup_table_TNRS, lookup_table_bdc)
nrow(lookup_table)
```

# Save lookup table as csv
```{r}
write.csv(lookup_table, file.path(output_path,"plant_lookup_table.csv"))
```

# Update data files species names using lookup table
## GBIF
```{r}
# filter data to species in lookup_table$Names_submitted
GBIF_occ_subset <- GBIF_occ %>%
  filter(species %in% lookup_table$Name_submitted)
nrow(GBIF_occ_subset)
# add accepted species column from lookup table based on species column
GBIF_occ_subset_harmonized <- merge(GBIF_occ_subset, lookup_table, by.x = "species", by.y = "Name_submitted")
nrow(GBIF_occ_subset_harmonized)
```

## TRY
```{r}

```

## BIEN
```{r}

```

## GIFT
```{r}

```


# Summary
```{r}
source("~/GitHub/neotropical_plants/functions/data_summary.R")
```

```{r}
data_summary(GBIF_occ_subset_harmonized, GBIF_occ_subset_harmonized$species, GBIF_occ_subset_harmonized$genus, GBIF_occ_subset_harmonized$family)
```


# Write data to csv
```{r}

```

