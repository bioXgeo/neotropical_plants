---
title: "Plant Trait Imputation"
author: "Hazel J. Anderson"
project: "Plant-Frugivore Diversity"
collaborators: "Beth E. Gerstner, Phoebe L. Zarnetske"
overview: "This script fill plant trait gaps with imputation."
data input: "TropicalAndes_all_plant_traits_standardized.csv"
data output: "TropicalAndes_imputed_plant_traits.csv"
date: "2023-10-04"
output: html_document
---

# Set file paths
```{r}
data_path_L1 <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
output_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/L1')
figure_path <- file.path('G:/Shared drives/SpaCE_Lab_FRUGIVORIA/data/plants/figures')
```

# Load required packages
```{r}
library(tidyr)
library(BIEN)
library(GIFT)
library(purrr)
library(mice)
library(dplyr)
```

# Read in data
```{r}
plant_traits <- read.csv(file.path(data_path_L1,"TropicalAndes_all_plant_traits_standardized.csv"))
```


# Use BIEN and GIFT to fill in gaps by genus or family.
Need a list of families and genus for each trait that needs requesting
2. add genus and family information to dataframe
3. list by trait of species and genus

## Create a dataframe of species and TraitNames with TraitValue = NA
```{r}
# remove X column
plant_traits <- plant_traits[, !colnames(plant_traits) %in% "X", drop = FALSE]

# Convert the wide dataframe to long format
long_plant_traits <- plant_traits %>%
  gather(TraitName, TraitValue, -species)
# Filter rows with NA values
na_traits <- long_plant_traits %>%
  filter(is.na(TraitValue))
dim(na_traits)

# get a list of species
na_species_list <- unique(plant_traits$species)
length(na_species_list)
```

```{r}
length(na_species_list)
```

## Add genus and family information to dataframe
```{r}
taxonomic_info <- BIEN_taxonomy_species(na_species_list)
```

```{r}
# keep only columns with family, genus, species
subset_df <- taxonomic_info[, c("scrubbed_family", "scrubbed_genus", "scrubbed_species_binomial")]
# remove duplicates
na_species_taxonomy <- distinct(subset_df)
# rename column to family, genus, species
na_species_taxonomy <- na_species_taxonomy %>%
  rename(family = scrubbed_family,
         genus = scrubbed_genus,
         species = scrubbed_species_binomial)
```

```{r}
# add to species dataframe
na_species_df <- as.data.frame(na_species_list)
names(na_species_df) <- "species"
na_species_df <- merge(na_species_df, na_species_taxonomy, by = "species", all.x = TRUE)

# retrieve list of species without family & genus information
species_no_family <- na_species_df %>%
  filter(is.na(family) | family == "") %>%
  select(species) %>%
  pull()
species_no_genus <- na_species_df %>%
  filter(is.na(genus) | genus == "") %>%
  select(species) %>%
  pull()

# check if all the species in no_family & no_genus lists are the same
identical(species_no_family, species_no_genus)

length(species_no_family)
```

Use taxize for species with no family and genus info
```{r, results='hide',message=FALSE, warning=FALSE}
library(taxize)

# Function to retrieve taxonomic information for a chunk of species names
get_taxonomic_info_chunk <- function(chunk_species_names) {
  # Initialize an empty list to store taxonomic information for each chunk
  chunk_taxonomic_info <- list()
  
  # Loop through each species name in the chunk and retrieve taxonomic information
  for (species_name in chunk_species_names) {
    tryCatch({
      # Add a delay between consecutive API requests
      Sys.sleep(1)
      
      # Make API request to retrieve taxonomic information
      taxon_info <- tax_name(species_name, get = c("genus", "family"), db = "ncbi")
      
      # Store taxonomic information for the species in the list
      chunk_taxonomic_info[[species_name]] <- data.frame(Species = species_name, 
                                                         Genus = taxon_info$genus, 
                                                         Family = taxon_info$family)
    }, error = function(e) {
      # Print error message
      cat("Error retrieving taxonomic information for", species_name, ":", conditionMessage(e), "\n")
    })
  }
  
  # Return the list of taxonomic information for the chunk
  return(chunk_taxonomic_info)
}

# Define the chunk size
chunk_size <- 300 # Adjust the chunk size as needed

# Split the dataframe into chunks based on the chunk size
chunks <- split(species_no_family, ceiling(seq_along(species_no_family) / chunk_size))

# Initialize an empty list to store taxonomic information for all chunks
all_taxonomic_info <- list()

# Iterate over each chunk and retrieve taxonomic information
for (chunk_index in seq_along(chunks)) {
  # Get the species names in the current chunk
  chunk_species_names <- chunks[[chunk_index]]
  
  # Retrieve taxonomic information for the chunk
  chunk_taxonomic_info <- get_taxonomic_info_chunk(chunk_species_names)
  
  # Append taxonomic information for the chunk to the list
  all_taxonomic_info <- c(all_taxonomic_info, list(chunk_taxonomic_info))
  
  # Add a delay 
  Sys.sleep(5)
}

# Combine taxonomic information from all chunks into a single list
all_taxonomic_info <- do.call(c, all_taxonomic_info)

# Combine the list of dataframes into a single dataframe
taxonomic_df <- do.call(rbind, all_taxonomic_info)
```

```{r}
# remove duplicates
taxonomic_df <- distinct(taxonomic_df)
# rename column to family, genus, species
taxonomic_df <- taxonomic_df %>%
  rename(family = Family,
         genus = Genus,
         species = Species)
```

```{r}
# add to species dataframe
na_species_df$family <- ifelse(is.na(na_species_df$family), taxonomic_df$family[match(na_species_df$species, taxonomic_df$species)], na_species_df$family)
na_species_df$genus <- ifelse(is.na(na_species_df$genus), taxonomic_df$genus[match(na_species_df$species, taxonomic_df$species)], na_species_df$genus)


# retrieve list of species without family & genus information
species_no_family_2 <- na_species_df %>%
  filter(is.na(family) | family == "") %>%
  select(species) %>%
  pull()
length(species_no_family_2)
```

```{r}
# get powo id
species_no_family_2_powo <- get_pow(species_no_family_2, messages = TRUE)
```


```{r}
# Function to retrieve taxonomic information for a chunk of taxon IDs
get_taxonomic_info_chunk <- function(chunk_taxon_id) {
  # Initialize an empty list to store taxonomic information for each chunk
  chunk_taxonomic_info <- list()
  
  # Loop through each taxon ID in the chunk and retrieve taxonomic information
  for (taxon_id in chunk_taxon_id) {
    tryCatch({
      # Print taxon ID for debugging
      print(paste("Processing taxon ID:", taxon_id))
      
      # Add a delay between consecutive API requests
      Sys.sleep(1)
      
      # Query POWO database for taxonomic information
      taxon_info <- pow_lookup(id = taxon_id)
      
      # Check if taxon_info is NULL
      if (is.null(taxon_info)) {
        # If taxon_info is NULL, return NA values for species, family, and genus
        chunk_taxonomic_info[[taxon_id]] <- data.frame(taxon_id = taxon_id, species = NA, family = NA, genus = NA)
      } else {
        # Store taxonomic information for the taxon ID in the list
        chunk_taxonomic_info[[taxon_id]] <- data.frame(taxon_id = taxon_id,
                                                        species = taxon_info$meta$name,
                                                        genus = taxon_info$meta$genus, 
                                                        family = taxon_info$meta$family)
      }
    }, error = function(e) {
      # Print error message for debugging
      print(paste("Error processing taxon ID:", taxon_id))
      print(e)
    })
  }
  
  # Return the list of taxonomic information for the chunk
  return(chunk_taxonomic_info)
}

# Define the chunk size
chunk_size <- 300 # Adjust the chunk size as needed

# Split the vector of taxon IDs into chunks based on the chunk size
chunks <- split(species_no_family_2_powo, ceiling(seq_along(species_no_family_2_powo) / chunk_size))

# Initialize an empty list to store taxonomic information for all chunks
all_taxonomic_info <- list()

# Iterate over each chunk and retrieve taxonomic information
for (chunk_index in seq_along(chunks)) {
  # Get the taxon IDs in the current chunk
  chunk_taxon_id <- chunks[[chunk_index]]
  
  # Retrieve taxonomic information for the chunk
  chunk_taxonomic_info <- get_taxonomic_info_chunk(chunk_taxon_id)
  
  # Append taxonomic information for the chunk to the list
  all_taxonomic_info <- c(all_taxonomic_info, list(chunk_taxonomic_info))
  
  # Add a delay 
  Sys.sleep(5)
}

# Combine taxonomic information from all chunks into a single list
all_taxonomic_info <- do.call(c, all_taxonomic_info)

# Combine the list of dataframes into a single dataframe
taxonomic_df <- do.call(rbind, all_taxonomic_info)

```

```{r}
# add to species dataframe
na_species_df$family <- ifelse(is.na(na_species_df$family), taxonomic_df$family[match(na_species_df$species, taxonomic_df$species)], na_species_df$family)
na_species_df$genus <- ifelse(is.na(na_species_df$genus), taxonomic_df$genus[match(na_species_df$species, taxonomic_df$species)], na_species_df$genus)


# retrieve list of species without family & genus information
species_no_family_3 <- na_species_df %>%
  filter(is.na(family) | family == "") %>%
  select(species) %>%
  pull()
length(species_no_family_3)
```

## Add genus and family info to dataframe with species and traits
```{r}
na_traits_family.genus <- merge(na_traits, na_species_df, by = "species", all.x = TRUE)
```

## Get a list for each trait of species, genus, and family to fill in gaps
```{r}
# Get unique traits
traits <- unique(na_traits_family.genus$TraitName)

# Create an empty list to store dataframes for each trait
trait_dfs <- list()

# Split the dataframe by traitName and create a dataframe for each trait
for (trait in traits) {
  # Subset the dataframe for the current trait
  trait_df <- subset(na_traits_family.genus, TraitName == trait)
  
  # Remove the traitName column from the subsetted dataframe
  trait_df <- trait_df[, !(names(trait_df) %in% "traitName")]
  
  # Add the dataframe to the list
  trait_dfs[[trait]] <- trait_df
}

# Separate dataframes from list
PlantLifespan_years <- trait_dfs$PlantLifespan_years
FruitType <- trait_dfs$FruitType
DispersalSyndrome <- trait_dfs$DispersalSyndrome
FruitMass_mg <- trait_dfs$FruitMass_mg
SeedLength_mm <- trait_dfs$SeedLength_mm
SeedWidth_mm <- trait_dfs$SeedWidth_mm
GrowthForm <- trait_dfs$GrowthForm
FruitLength_mm <- trait_dfs$FruitLength_mm
SeedMass_g <- trait_dfs$SeedMass_g
PlantHeight_m <- trait_dfs$PlantHeight_m
```

## Create a list of unique genus and families for each trait
```{r}
PlantLifespan_years_families <- unique(PlantLifespan_years$family)
PlantLifespan_years_genus <- unique(PlantLifespan_years$genus)
length(PlantLifespan_years_families)
length(PlantLifespan_years_genus)
```

```{r}
FruitType_families <- unique(FruitType$family)
FruitType_genus <- unique(FruitType$genus)
length(FruitType_families)
length(FruitType_genus)
```

```{r}
DispersalSyndrome_families <- unique(DispersalSyndrome$family)
DispersalSyndrome_genus <- unique(DispersalSyndrome$genus)
length(DispersalSyndrome_families)
length(DispersalSyndrome_genus)
```

```{r}
FruitMass_mg_families <- unique(FruitMass_mg$family)
FruitMass_mg_genus <- unique(FruitMass_mg$genus)
length(FruitMass_mg_families)
length(FruitMass_mg_genus)
```

```{r}
SeedLength_mm_families <- unique(SeedLength_mm$family)
SeedLength_mm_genus <- unique(SeedLength_mm$genus)
length(SeedLength_mm_families)
length(SeedLength_mm_genus)
```

```{r}
SeedWidth_mm_families <- unique(SeedWidth_mm$family)
SeedWidth_mm_genus <- unique(SeedWidth_mm$genus)
length(SeedWidth_mm_families)
length(SeedWidth_mm_genus)
```

```{r}
GrowthForm_families <- unique(GrowthForm$family)
GrowthForm_genus <- unique(GrowthForm$genus)
length(GrowthForm_families)
length(GrowthForm_genus)
```

```{r}
FruitLength_mm_families <- unique(FruitLength_mm$family)
FruitLength_mm_genus <- unique(FruitLength_mm$genus)
length(FruitLength_mm_families)
length(FruitLength_mm_genus)
```

```{r}
SeedMass_g_families <- unique(SeedMass_g$family)
SeedMass_g_genus <- unique(SeedMass_g$genus)
length(SeedMass_g_families)
length(SeedMass_g_genus)
```

```{r}
PlantHeight_m_families <- unique(PlantHeight_m$family)
PlantHeight_m_genus <- unique(PlantHeight_m$genus)
length(PlantHeight_m_families)
length(PlantHeight_m_genus)
```


## Retrive trait records for species using BIEN & GIFT
### Plant Lifespan
```{r}
PlantLifespan_years_families_BIEN <- BIEN_trait_traitbyfamily(family = PlantLifespan_years_families, trait = "maximum whole plant longevity")
PlantLifespan_years_genus_BIEN <- BIEN_trait_traitbygenus(genus = PlantLifespan_years_genus, trait = "maximum whole plant longevity")

# Error in GIFT_traits_tax(trait_IDs = "2.2.1") :   None of the traits asked was available at the taxonomic level.
#PlantLifespan_years_families_GIFT <- GIFT_traits_tax(trait_IDs = "2.2.1")
#PlantLifespan_years_families_GIFT <- PlantLifespan_years_families_GIFT[PlantLifespan_years_families_GIFT$family %in% PlantLifespan_years_families, ]
```

```{r}
nrow(PlantLifespan_years_families_BIEN)
length(unique(PlantLifespan_years_families_BIEN$scrubbed_family))
unique(PlantLifespan_years_families_BIEN$trait_value)
```

```{r}
nrow(PlantLifespan_years_genus_BIEN)
length(unique(PlantLifespan_years_genus_BIEN$scrubbed_genus))
unique(PlantLifespan_years_genus_BIEN$trait_value)
```

### Fruit Type
```{r}
FruitType_families_BIEN <- BIEN_trait_traitbyfamily(family = FruitType_families, trait = "fruit type")
FruitType_genus_BIEN <- BIEN_trait_traitbygenus(genus = FruitType_genus, trait = "fruit type")

# Error in GIFT_traits_tax(trait_IDs = "3.16.1") :   None of the traits asked was available at the taxonomic level.
#Fruit.Type_families_GIFT <- GIFT_traits_tax(trait_IDs = "3.16.1")
#Fruit.Type_families_GIFT <- Fruit.Type_families_GIFT[Fruit.Type_families_GIFT$family %in% Fruit.Type_families, ]
```

```{r}
nrow(FruitType_families_BIEN)
length(unique(FruitType_families_BIEN$scrubbed_family))
unique(FruitType_families_BIEN$trait_value)
```

```{r}
nrow(FruitType_genus_BIEN)
length(unique(FruitType_genus_BIEN$scrubbed_genus))
unique(FruitType_genus_BIEN$trait_value)
```

### Dispersal Syndrome
```{r}
DispersalSyndrome_families_BIEN <- BIEN_trait_traitbyfamily(family = DispersalSyndrome_families, trait = "whole plant dispersal syndrome")
DispersalSyndrome_genus_BIEN <- BIEN_trait_traitbygenus(genus = DispersalSyndrome_genus, trait = "whole plant dispersal syndrome")

DispersalSyndrome_families_GIFT <- GIFT_traits_tax(trait_IDs = "3.3.1")
DispersalSyndrome_families_GIFT <- DispersalSyndrome_families_GIFT[DispersalSyndrome_families_GIFT$family %in% DispersalSyndrome_families, ]
```

```{r}
nrow(DispersalSyndrome_families_BIEN)
length(unique(DispersalSyndrome_families_BIEN$scrubbed_family))
unique(DispersalSyndrome_families_BIEN$trait_value)
```
```{r}
nrow(DispersalSyndrome_genus_BIEN)
length(unique(DispersalSyndrome_genus_BIEN$scrubbed_genus))
unique(DispersalSyndrome_genus_BIEN$trait_value)
```

```{r}
nrow(DispersalSyndrome_families_GIFT)
```
This information is not useful to fill in trait gaps.

### Fruit Mass
No information in BIEN or GIFT

### Seed Length
Only in GIFT: Seed_length_min (3.10.1), Seed_length_max (3.10.2), Seed_length_mean (3.10.3)
```{r}
SeedLength_mm_families_GIFT <- GIFT_traits_tax(trait_IDs = c("3.10.1", "3.10.2", "3.10.3"))
SeedLength_mm_families_GIFT <- SeedLength_mm_families_GIFT[SeedLength_mm_families_GIFT$family %in% SeedLength_mm_families, ]
```

```{r}
nrow(SeedLength_mm_families_GIFT)
```

### Seed Width
Only in GIFT: Seed_width_min (3.11.1), Seed_width_max (3.11.2), Seed_width_mean (3.11.3)
```{r}
#Error in GIFT_traits_tax(trait_IDs = c("3.11.1", "3.11.2", "3.11.3")) :   None of the traits asked was available at the taxonomic level.
#SeedWidth_mm_families_GIFT <- GIFT_traits_tax(trait_IDs = c("3.11.1", "3.11.2", "3.11.3"))
#SeedWidth_mm_families_GIFT <- SeedWidth_mm_families_GIFT[SeedWidth_mm_families_GIFT$family %in% SeedWidth_mm_families, ]
```


### Growth Form
```{r}
# Growth Form
GrowthForm_families_BIEN <- BIEN_trait_traitbyfamily(family = GrowthForm_families, trait = "whole plant growth form")
GrowthForm_genus_BIEN <- BIEN_trait_traitbygenus(genus = GrowthForm_genus, trait = "whole plant growth form")

# Error in GIFT_traits_tax(trait_IDs = "1.2.1") :   None of the traits asked was available at the taxonomic level.
#Growth.Form_families_GIFT <- GIFT_traits_tax(trait_IDs = "1.2.1")
#Growth.Form_families_GIFT <- Growth.Form_families_GIFT[Growth.Form_families_GIFT$family %in% Growth.Form_families, ]
```

```{r}
nrow(GrowthForm_families_BIEN)
length(unique(GrowthForm_families_BIEN$scrubbed_family))
unique(GrowthForm_families_BIEN$trait_value)
```

```{r}
nrow(GrowthForm_genus_BIEN)
length(unique(GrowthForm_genus_BIEN$scrubbed_genus))
unique(GrowthForm_genus_BIEN$trait_value)
```

### Fruit Length
```{r}
FruitLength_mm_families_BIEN <- BIEN_trait_traitbyfamily(family = FruitLength_mm_families, trait = c("maximum fruit length", "minimum fruit length"))
FruitLength_mm_genus_BIEN <- BIEN_trait_traitbygenus(genus = FruitLength_mm_genus, trait = c("maximum fruit length", "minimum fruit length"))

#Error in GIFT_traits_tax(trait_IDs = "3.13.3") : None of the traits asked was available at the taxonomic level.
#Fruit.Length_families_GIFT <- GIFT_traits_tax(trait_IDs = "3.13.3")
#Fruit.Length_families_GIFT <- Fruit.Length_families_GIFT[Fruit.Length_families_GIFT$family %in% Fruit.Length_families, ]
```

```{r}
nrow(FruitLength_mm_families_BIEN)
length(unique(FruitLength_mm_families_BIEN$scrubbed_family))
unique(FruitLength_mm_families_BIEN$trait_value)
```

```{r}
nrow(FruitLength_mm_genus_BIEN)
length(unique(FruitLength_mm_genus_BIEN$scrubbed_genus))
unique(FruitLength_mm_genus_BIEN$trait_value)
```

### Seed Mass
```{r}
SeedMass_g_families_BIEN <- BIEN_trait_traitbyfamily(family = SeedMass_g_families, trait = "seed mass")
SeedMass_g_genus_BIEN <- BIEN_trait_traitbygenus(genus = SeedMass_g_genus, trait = "seed mass")


SeedMass_g_families_GIFT <- GIFT_traits_tax(trait_IDs = c("3.2.1", "3.2.2", "3.2.3"))
SeedMass_g_families_GIFT <- SeedMass_g_families_GIFT[SeedMass_g_families_GIFT$family %in% SeedMass_g_families, ]
```

```{r}
nrow(SeedMass_g_families_BIEN)
length(unique(SeedMass_g_families_BIEN$scrubbed_family))
unique(SeedMass_g_families_BIEN$trait_value)
```

```{r}
nrow(SeedMass_g_genus_BIEN)
length(unique(SeedMass_g_genus_BIEN$scrubbed_genus))
unique(SeedMass_g_genus_BIEN$trait_value)
```

```{r}
nrow(SeedMass_g_families_GIFT)
```

### Plant Height
```{r}
PlantHeight_m_families_BIEN <- BIEN_trait_traitbyfamily(family = PlantHeight_m_families, trait = "whole plant height")
PlantHeight_m_genus_BIEN <- BIEN_trait_traitbygenus(genus = PlantHeight_m_genus, trait = "whole plant height")

#Error in GIFT_traits_tax(trait_IDs = "1.6.3") :   None of the traits asked was available at the taxonomic level.
#Plant.Height_families_GIFT <- GIFT_traits_tax(trait_IDs = "1.6.3")
#Plant.Height_families_GIFT <- Plant.Height_families_GIFT[Plant.Height_families_GIFT$family %in% Plant.Height_families, ]
```

```{r}
nrow(PlantHeight_m_families_BIEN)
length(unique(PlantHeight_m_families_BIEN$scrubbed_family))
unique(PlantHeight_m_families_BIEN$trait_value)
```

```{r}
nrow(PlantHeight_m_genus_BIEN)
length(unique(PlantHeight_m_genus_BIEN$scrubbed_genus))
unique(PlantHeight_m_genus_BIEN$trait_value)
```


## Clean new trait data
Make sure numeric traits match the units of existing trait table. Numeric traits should only contain numeric values and non-numeric traits should only have non-numeric trait values. 
### # Lifespan
remove non-numeric trait values
```{r}
PlantLifespan_years_families_BIEN <- PlantLifespan_years_families_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(PlantLifespan_years_families_BIEN)
unique(PlantLifespan_years_families_BIEN$unit)

PlantLifespan_years_genus_BIEN <- PlantLifespan_years_genus_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(PlantLifespan_years_genus_BIEN)
unique(PlantLifespan_years_genus_BIEN$unit)
```

# Fruit type
haromonize trait values
```{r}
unique(FruitType_families_BIEN$trait_value)
unique(FruitType_genus_BIEN$trait_value)
FruitType_families_BIEN <- FruitType_families_BIEN %>%
  filter() %>%
  mutate(trait_value = case_when(
    grepl('Berry|berry|Berry ', trait_value, ignore.case = TRUE) ~ "berry",
    grepl('capsule|Capsule|Capsule ', trait_value, ignore.case = TRUE) ~ "capsule",
    grepl('drupe|Drupe|Drupe |Drupaceous', trait_value, ignore.case = TRUE) ~ "drupe",
    grepl('Squash', trait_value, ignore.case = TRUE) ~ "squash",
    grepl('pod|Pod|Pod ', trait_value, ignore.case = TRUE) ~ "pod",
    grepl('Samara|Samaroid', trait_value, ignore.case = TRUE) ~ "samara"
  )) %>%
  filter(!is.na(trait_value))
FruitType_genus_BIEN <- FruitType_genus_BIEN %>%
  filter() %>%
  mutate(trait_value = case_when(
    grepl('Berry|berry|Berry ', trait_value, ignore.case = TRUE) ~ "berry",
    grepl('capsule|Capsule|Capsule ', trait_value, ignore.case = TRUE) ~ "capsule",
    grepl('drupe|Drupe|Drupe |Drupaceous', trait_value, ignore.case = TRUE) ~ "drupe",
    grepl('Squash', trait_value, ignore.case = TRUE) ~ "squash",
    grepl('pod|Pod|Pod ', trait_value, ignore.case = TRUE) ~ "pod",
    grepl('Samara|Samaroid', trait_value, ignore.case = TRUE) ~ "samara"
  )) %>%
  filter(!is.na(trait_value))
unique(FruitType_families_BIEN$trait_value)
unique(FruitType_genus_BIEN$trait_value)
```

# Growth form
harmonize trait values and remove numeric values
```{r}
# remove numeric rows
GrowthForm_families_BIEN <- GrowthForm_families_BIEN %>%
  filter(is.na(as.numeric(trait_value)))
nrow(GrowthForm_families_BIEN)
GrowthForm_genus_BIEN <- GrowthForm_genus_BIEN %>%
  filter(is.na(as.numeric(trait_value)))
nrow(GrowthForm_genus_BIEN)
```

```{r}
# classify values as herb, shrub, tree, or other
GrowthForm_families_BIEN <- GrowthForm_families_BIEN %>%
  mutate(Category = case_when(
    grepl("herb", trait_value, ignore.case = TRUE) ~ "herb",
    grepl("shrub", trait_value, ignore.case = TRUE) ~ "shrub",
    grepl("tree", trait_value, ignore.case = TRUE) ~ "tree",
    TRUE ~ "other"
  ))
GrowthForm_genus_BIEN <- GrowthForm_genus_BIEN %>%
  mutate(Category = case_when(
    grepl("herb", trait_value, ignore.case = TRUE) ~ "herb",
    grepl("shrub", trait_value, ignore.case = TRUE) ~ "shrub",
    grepl("tree", trait_value, ignore.case = TRUE) ~ "tree",
    TRUE ~ "other"
  ))
```

### Fruit length
remove non-numeric trait values and check units
```{r}
FruitLength_mm_families_BIEN <- FruitLength_mm_families_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(FruitLength_mm_families_BIEN)
unique(FruitLength_mm_families_BIEN$unit)

FruitLength_mm_genus_BIEN <- FruitLength_mm_genus_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(FruitLength_mm_genus_BIEN)
unique(FruitLength_mm_genus_BIEN$unit)
```

### Seed mass
remove non-numeric trait values and check units
```{r}
SeedMass_g_families_BIEN <- SeedMass_g_families_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(SeedMass_g_families_BIEN)
unique(SeedMass_g_families_BIEN$unit)

SeedMass_g_genus_BIEN <- SeedMass_g_genus_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(SeedMass_g_genus_BIEN)
unique(SeedMass_g_genus_BIEN$unit)

```

### Plant Height
remove non-numeric trait values and check units
```{r}
PlantHeight_m_families_BIEN <- PlantHeight_m_families_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(PlantHeight_m_families_BIEN)
unique(PlantHeight_m_families_BIEN$unit)

PlantHeight_m_genus_BIEN <- PlantHeight_m_genus_BIEN %>%
  filter(!is.na(as.numeric(trait_value))) %>%
  mutate(trait_value = as.numeric(trait_value))

nrow(PlantHeight_m_genus_BIEN)
unique(PlantHeight_m_genus_BIEN$unit)
```

## Combine new info with existing trait table

To fill in gaps of missing traits, use genus level data first then family level. Add column to trait dataframe of the level of trait measurement: species, genus, family.

### Subset dataframe to only keep required columns
```{r}
# for traits to family level from BIEN, keep columns of scrubbed_family, trait_name, trait_value
PlantLifespan_years_families_BIEN_df <- PlantLifespan_years_families_BIEN[, c("scrubbed_family", "trait_name", "trait_value")]
FruitType_families_BIEN_df <- FruitType_families_BIEN[, c("scrubbed_family", "trait_name", "trait_value")]
GrowthForm_families_BIEN_df <- GrowthForm_families_BIEN[, c("scrubbed_family", "trait_name", "trait_value")]
FruitLength_mm_families_BIEN_df <- FruitLength_mm_families_BIEN[, c("scrubbed_family", "trait_name", "trait_value")]
SeedMass_g_families_BIEN_df <- SeedMass_g_families_BIEN[, c("scrubbed_family", "trait_name", "trait_value")]
PlantHeight_m_families_BIEN_df <- PlantHeight_m_families_BIEN[, c("scrubbed_family", "trait_name", "trait_value")]
```

```{r}
# for traits to genus level from BIEN, keep columns of scrubbed_genus, trait_name, trait_value
PlantLifespan_years_genus_BIEN_df <- PlantLifespan_years_genus_BIEN[, c("scrubbed_genus", "trait_name", "trait_value")]
FruitType_genus_BIEN_df <- FruitType_genus_BIEN[, c("scrubbed_genus", "trait_name", "trait_value")]
GrowthForm_genus_BIEN_df <- GrowthForm_genus_BIEN[, c("scrubbed_genus", "trait_name", "trait_value")]
FruitLength_mm_genus_BIEN_df <- FruitLength_mm_genus_BIEN[, c("scrubbed_genus", "trait_name", "trait_value")]
SeedMass_g_genus_BIEN_df <- SeedMass_g_genus_BIEN[, c("scrubbed_genus", "trait_name", "trait_value")]
PlantHeight_m_genus_BIEN_df <- PlantHeight_m_genus_BIEN[, c("scrubbed_genus", "trait_name", "trait_value")]
```

### Get a single trait value for each family/genus
```{r}
# numeric traits
numeric_traits_combined <- function(df, level, traitname) {
  df$trait_value <- as.numeric(df$trait_value)
  if (level == "genus") {
    summary_data <- df %>%
      group_by(scrubbed_genus) %>%
          summarise(
            trait_value_mean = exp(mean(log(trait_value))),
            records_used = n(),
            variance = var(trait_value, na.rm = TRUE)
          )
      # Add trait name column
      summary_data$TraitName <- traitname
  
      # Rename the mean column to TraitValue
      summary_data <- summary_data %>%
        rename(trait_value = trait_value_mean)
  
    return(summary_data)
  } else if (level == "family") {
    summary_data <- df %>%
      group_by(scrubbed_family) %>%
      summarise(
            trait_value_mean = exp(mean(log(trait_value))),
            records_used = n(),
            variance = var(trait_value, na.rm = TRUE)
          )
      # Add trait name column
      summary_data$TraitName <- traitname
  
      # Rename the mean column to TraitValue
      summary_data <- summary_data %>%
        rename(TraitValue = trait_value_mean)
  
    return(summary_data)
  }
}

# non-numeric traits
cat_traits_combined <- function(df, level, traitname){
  if (level == "genus") {
    summary_data <- df %>%
      group_by(scrubbed_genus) %>%
      summarise(
        ModeValue = names(sort(table(trait_value), decreasing = TRUE))[1],
        records_used = n(),
        mode_freq = max(table(trait_value)),
        variance = 1 - (max(table(trait_value)) / n())
    )
  
    # Add trait name column
    summary_data$TraitName <- traitname
  
    # Rename the mean column to TraitValue
    summary_data <- summary_data %>%
      rename(TraitValue = ModeValue)
  
  return(summary_data)
  } else if (level == "family") {
    summary_data <- df %>%
      group_by(scrubbed_family) %>%
      summarise(
        ModeValue = names(sort(table(trait_value), decreasing = TRUE))[1],
        records_used = n(),
        mode_freq = max(table(trait_value)),
        variance = 1 - (max(table(trait_value)) / n())
    )
  
    # Add trait name column
    summary_data$TraitName <- traitname
  
    # Rename the mean column to TraitValue
    summary_data <- summary_data %>%
      rename(TraitValue = ModeValue)
  
  return(summary_data)
  }
}

```

```{r}
dim(PlantLifespan_years_families_BIEN_df)
PlantLifespan_years_families_BIEN_df_average <- numeric_traits_combined(PlantLifespan_years_families_BIEN_df, "family", "PlantLifespan_years")
dim(PlantLifespan_years_families_BIEN_df_average)

dim(PlantLifespan_years_genus_BIEN_df)
PlantLifespan_years_genus_BIEN_df_average <- numeric_traits_combined(PlantLifespan_years_genus_BIEN_df, "genus", "PlantLifespan_years")
dim(PlantLifespan_years_genus_BIEN_df_average)
```

```{r}
dim(FruitType_families_BIEN_df)
FruitType_families_BIEN_df_average <- cat_traits_combined(FruitType_families_BIEN_df, "family", "FruitType")
dim(FruitType_families_BIEN_df_average)

dim(FruitType_genus_BIEN_df)
FruitType_genus_BIEN_df_average <- cat_traits_combined(FruitType_genus_BIEN_df, "genus", "FruitType")
dim(FruitType_genus_BIEN_df_average)
```

```{r}
dim(GrowthForm_families_BIEN_df)
GrowthForm_families_BIEN_df_average <- cat_traits_combined(GrowthForm_families_BIEN_df, "family", "GrowthForm")
dim(GrowthForm_families_BIEN_df_average)

dim(GrowthForm_genus_BIEN_df)
GrowthForm_genus_BIEN_df_average <- cat_traits_combined(GrowthForm_genus_BIEN_df, "genus", "GrowthForm")
dim(GrowthForm_genus_BIEN_df_average)
```

```{r}
dim(FruitLength_mm_families_BIEN_df)
FruitLength_mm_families_BIEN_df_average <- numeric_traits_combined(FruitLength_mm_families_BIEN_df, "family", "FruitLength_mm")
dim(FruitLength_mm_families_BIEN_df_average)

dim(FruitLength_mm_genus_BIEN_df)
FruitLength_mm_genus_BIEN_df_average <- numeric_traits_combined(FruitLength_mm_genus_BIEN_df, "genus", "FruitLength_mm")
dim(FruitLength_mm_genus_BIEN_df_average)
```

```{r}
dim(SeedMass_g_families_BIEN_df)
SeedMass_g_families_BIEN_df_average <- numeric_traits_combined(SeedMass_g_families_BIEN_df, "family", "SeedMass_g")
dim(PlantLifespan_years_families_BIEN_df_average)

dim(SeedMass_g_genus_BIEN_df)
SeedMass_g_genus_BIEN_df_average <- numeric_traits_combined(SeedMass_g_genus_BIEN_df, "genus", "SeedMass_g")
dim(SeedMass_g_genus_BIEN_df_average)
```

```{r}
dim(PlantHeight_m_families_BIEN_df)
PlantHeight_m_families_BIEN_df_average <- numeric_traits_combined(PlantHeight_m_families_BIEN_df, "family", "PlantHeight_m")
dim(PlantHeight_m_families_BIEN_df_average)

dim(PlantHeight_m_genus_BIEN_df)
PlantHeight_m_genus_BIEN_df_average <- numeric_traits_combined(PlantHeight_m_genus_BIEN_df, "genus", "PlantHeight_m")
dim(PlantHeight_m_genus_BIEN_df_average)
```


### Add column of trait level (species, genus, family)
```{r}
# Add new column trait_level to long_plant_trait dataframe
long_plant_traits <- long_plant_traits %>%
  mutate(TraitLevel = ifelse(!is.na(TraitValue), "species", NA))
```

```{r}
# add family and genus information to long_plant_trait dataframe
long_plant_traits_tax <- merge(long_plant_traits, na_species_df, by = "species", all.x = TRUE)
```

#### Combine all family level trait data
```{r}
colnames(PlantLifespan_years_families_BIEN_df_average)
colnames(FruitType_families_BIEN_df_average)
colnames(GrowthForm_families_BIEN_df_average)
colnames(FruitLength_mm_families_BIEN_df_average)
colnames(SeedMass_g_families_BIEN_df_average)
colnames(PlantHeight_m_families_BIEN_df_average)
```

```{r}
family_level_trait_data <- list(PlantLifespan_years_families_BIEN_df_average, FruitType_families_BIEN_df_average, GrowthForm_families_BIEN_df_average, FruitLength_mm_families_BIEN_df_average, SeedMass_g_families_BIEN_df_average, PlantHeight_m_genus_BIEN_df_average)

# Function to select and convert columns to character
select_and_convert <- function(df) {
  df %>%
    select(scrubbed_family, TraitName, TraitValue) %>%
    mutate(across(everything(), as.character))
}

# Apply the function to each dataframe in the list and combine them
all_family_traits <- family_level_trait_data %>%
  purrr::map_df(select_and_convert)
```

```{r}
## add trait level column
all_family_traits$TraitLevel <- "family"
```


#### Combine all genus level trait data
```{r}
## add column of trait_name for numeric traits
Dispersal.Syndrome_genus_BIEN_df$trait_name <- "Dispersal.Syndrome"
Fruit.Length_genus_BIEN_df$trait_name <- "Fruit.Length_mm"
Plant.Height_genus_BIEN_df$trait_name <- "Plant.Height_m"
Fruit.Type_genus_BIEN_df$trait_name <- "Fruit.Type"
Growth.Form_genus_BIEN_df$trait_name <- "Growth.Form"

## rename TraitValue column so it's consistent with other traits
Fruit.Type_genus_BIEN_df$TraitValue <- Fruit.Type_genus_BIEN_df$trait_value_mode_trait
Growth.Form_genus_BIEN_df$TraitValue <- Growth.Form_genus_BIEN_df$trait_value_mode_trait

## convert numeric trait values into character
Plant.Height_genus_BIEN_df$TraitValue <- as.character(Plant.Height_genus_BIEN_df$TraitValue)
Fruit.Length_genus_BIEN_df$TraitValue <- as.character(Fruit.Length_genus_BIEN_df$TraitValue)

all_genus_traits <- bind_rows(
  select(Dispersal.Syndrome_genus_BIEN_df, scrubbed_genus, trait_name, TraitValue),
  select(Fruit.Length_genus_BIEN_df, scrubbed_genus, trait_name, TraitValue),
  select(Plant.Height_genus_BIEN_df, scrubbed_genus, trait_name, TraitValue),
  select(Fruit.Type_genus_BIEN_df, scrubbed_genus, trait_name, TraitValue),
  select(Growth.Form_genus_BIEN_df, scrubbed_genus, trait_name, TraitValue)
  )

## add trait level column
all_genus_traits$TraitLevel <- "genus"
```

rename traits to match
```{r}
# Replace trait names to match
long_plant_traits_tax <- long_plant_traits_tax %>%
  mutate(TraitName = ifelse(TraitName == "Plant.Height", "Plant.Height_m", TraitName)) %>%
  mutate(TraitName = ifelse(TraitName == "Fruit.Length", "Fruit.Length_mm", TraitName))
unique(long_plant_traits_tax$TraitName)

na_traits_family.genus <- na_traits_family.genus %>%
  mutate(TraitName = ifelse(TraitName == "Plant.Height", "Plant.Height_m", TraitName)) %>%
  mutate(TraitName = ifelse(TraitName == "Fruit.Length", "Fruit.Length_mm", TraitName))
unique(na_traits_family.genus$TraitName)
```


make sure column names match between dataframes before combining
```{r}
colnames(all_family_traits)
colnames(all_genus_traits)
colnames(long_plant_traits_tax)
colnames(na_traits_family.genus)
```

```{r}
colnames(all_family_traits)[which(colnames(all_family_traits) == "scrubbed_family")] <- "family"
colnames(all_family_traits)[which(colnames(all_family_traits) == "trait_name")] <- "TraitName"
colnames(all_family_traits)[which(colnames(all_family_traits) == "trait_value")] <- "TraitValue"

colnames(all_genus_traits)[which(colnames(all_genus_traits) == "scrubbed_genus")] <- "genus"
colnames(all_genus_traits)[which(colnames(all_genus_traits) == "trait_name")] <- "TraitName"
colnames(all_genus_traits)[which(colnames(all_genus_traits) == "trait_value")] <- "TraitValue"
```

use family & genus level traits to fill in gaps of na_traits_family.genus
genus level prefered over family
```{r}
# Join the dataframes based on genus and TraitName
filled_na_traits_family.genus <- na_traits_family.genus %>%
  left_join(all_genus_traits, by = c("genus", "TraitName"), relationship = "many-to-many") %>%
  # Fill in TraitValue column with values from all_genus_traits
  mutate(TraitValue = coalesce(TraitValue.x, TraitValue.y)) %>%
  # Remove the columns
  select(-TraitValue.y, -TraitValue.x)
```

```{r}
na_traits_after_genus <- filled_na_traits_family.genus %>%
  filter(is.na(TraitValue))
filled_traits_with_genus <- filled_na_traits_family.genus %>%
  filter(!is.na(TraitValue))
```

```{r}
# Join the dataframes based on family and TraitName
## remove trait level column from na_traits_after_genus
na_traits_after_genus <- na_traits_after_genus %>%
  select(-TraitLevel)
filled_na_traits_family <- na_traits_after_genus %>%
  left_join(all_family_traits, by = c("family", "TraitName"), relationship = "many-to-many") %>%
  # Fill in TraitValue column with values from all_genus_traits
  mutate(TraitValue = coalesce(TraitValue.x, TraitValue.y)) %>%
  # Remove the columns
  select(-TraitValue.y, -TraitValue.x)
```

```{r}
filled_traits_with_family <- filled_na_traits_family %>%
  filter(!is.na(TraitValue))
na_traits_after_family <- filled_na_traits_family %>%
  filter(is.na(TraitValue))
```

```{r}
nonimputed_traits <- long_plant_traits_tax %>%
  filter(!is.na(TraitValue))
```

combine filled_traits_with_genus, filled_traits_with_family, and nonimputed_traits
```{r}
colnames(filled_traits_with_genus)
colnames(filled_traits_with_family)
colnames(nonimputed_traits)
```

```{r}
all_traits_with_tax <- rbind(filled_traits_with_genus, filled_traits_with_family, nonimputed_traits)
```


```{r}
all_traits_with_tax %>%
  group_by(TraitName) %>%
  summarise(num_species = n_distinct(species))
```

```{r}
na_traits_after_family %>%
  group_by(TraitName) %>%
  summarise(num_species = n_distinct(species))
```

add NAs back to all traits
```{r}
colnames(all_traits_with_tax)
colnames(na_traits_after_family)
```

```{r}
all_traits_with_NAs <- rbind(all_traits_with_tax, na_traits_after_family)
```

### Save long dataframe
```{r}
write.csv(all_traits_with_NAs, file.path(output_path,"TropicalAndes_all_plant_traits_filled_with_family_genus_long.csv"))
```

## Convert long dataframe to wide
```{r}
#remove unused columns
all_traits_with_NAs_long <- all_traits_with_NAs %>%
  select(-TraitLevel, -family, -genus)
wide_traits <- pivot_wider(all_traits_with_NAs_long, names_from = TraitName, values_from = TraitValue)
```
make NA if:
- Growth.Form is numeric
- Dispersal.Syndrome is numeric or contains multiple values
- Plant.Height = 0
- Fruit.Type is numeric
```{r}
library(stringr)
wide_traits$Growth.Form <- ifelse(is.numeric(wide_traits$Growth.Form), NA, wide_traits$Growth.Form)
wide_traits$Dispersal.Syndrome[stringr::str_detect(wide_traits$Dispersal.Syndrome, ",")] <- NA

# Convert Plant.Height_m to numeric 
wide_traits$Plant.Height_m[wide_traits$Plant.Height_m == "0"] <- NA

wide_traits$Fruit.Type <- ifelse(is.numeric(wide_traits$Fruit.Type), NA, wide_traits$Fruit.Type)
```

```{r}
wide_traits <- wide_traits %>%
  mutate_all(~sapply(., paste, collapse = ", "))

# Replace values with multiple values with NA
wide_traits <- wide_traits %>%
  mutate(Dispersal.Syndrome = if_else(str_count(Dispersal.Syndrome, ", ") > 0, NA_character_, Dispersal.Syndrome), 
         Growth.Form = if_else(str_count(Growth.Form, ", ") > 0, NA_character_, Growth.Form),
         Plant.Height_m = if_else(str_count(Plant.Height_m, ", ") > 0, NA_character_, Plant.Height_m), 
         Fruit.Length_mm = if_else(str_count(Fruit.Length_mm, ", ") > 0, NA_character_, Fruit.Length_mm), 
         Fruit.Type = if_else(str_count(Fruit.Type, ", ") > 0, NA_character_, Fruit.Type))
```


```{r}
wide_traits$Plant.Height_m <- unlist(wide_traits$Plant.Height_m)
wide_traits$Growth.Form <- unlist(wide_traits$Growth.Form)
wide_traits$Dispersal.Syndrome <- unlist(wide_traits$Dispersal.Syndrome)
wide_traits$Fruit.Length_mm <- unlist(wide_traits$Fruit.Length_mm)
wide_traits$Fruit.Type <- unlist(wide_traits$Fruit.Type)

#convert column types from list to character & numeric
wide_traits$Plant.Height_m <- as.numeric(wide_traits$Plant.Height_m)
wide_traits$Growth.Form <- as.character(wide_traits$Growth.Form)
wide_traits$Dispersal.Syndrome <- as.character(wide_traits$Dispersal.Syndrome)
wide_traits$Fruit.Length_mm <- as.numeric(wide_traits$Fruit.Length_mm)
wide_traits$Fruit.Type <- as.character(wide_traits$Fruit.Type)
```



# Impute Traits
## Set the seed for reproducibility
```{r}
set.seed(123)
```


# show the missing data pattern
```{r}
md.pattern(wide_traits)
```
# Perform the imputation
```{r}
imp_model <- mice(wide_traits, method = "cart", maxit = 20)
```

```{r}
imputed_data <- complete(imp_model)
```

remove dispersal syndrome because I need to fix it 
```{r}
imputed_data <- imputed_data %>%
  select(-Dispersal.Syndrome)
```

```{r}
imputed_data %>%
  summarise_at(vars(Growth.Form:Fruit.Type), ~ sum(is.na(.)))
```

# Save imputed data
```{r}
write.csv(imputed_data, file.path(output_path,"TropicalAndes_imputed_plant_traits.csv"))
```

